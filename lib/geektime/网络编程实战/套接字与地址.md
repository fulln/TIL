---
dg-publish: true
---

#极客时间 #java #tcp 

## 03丨套接字和地址：像电话和电话号码一样理解它们


### socket含义

socket 也可以看做是对物理世界的直接映射

![](/attachment/Pasted%20image%2020230305232945.png)

#### 连接过程

首先初始化 socket，之后服务器端需要执行 bind 函数，将自己的服务能力绑定在一个众所周知的地址和端口上，紧接着，服务器端执行 listen 操作，将原先的 socket 转化为服务端的 socket，服务端最后阻塞在 accept 上等待客户端请求的到来。 **TCP 三次握手（Three-way Handshake）**

一旦连接建立，数据的传输就不再是单向的，而是双向的，这也是 TCP 的一个显著特性。

#### socket地址格式

##### 通用套接字地址格式  sockaddr 

```C
/* POSIX.1g 规范规定了地址族为2字节的值.  */
typedef unsigned short int sa_family_t;
/* 描述通用套接字地址  */
struct sockaddr{
    sa_family_t sa_family;  /* 地址族.  16-bit*/
    char sa_data[14];   /* 具体的地址值 112-bit */
  }; 
```

1. 地址族 Address Family

常用的包含
- AF_LOCAL：表示的是本地地址，对应的是 Unix 套接字，这种情况一般用于本地 socket 通信，很多情况下也可以写成 AF_UNIX、AF_FILE；
- AF_INET：因特网使用的 IPv4 地址；
- AF_INET6：因特网使用的 IPv6 地址。

2. 地址值 14字节

**通用地址长度固定16字节**

##### IPv4 套接字格式地址

```c

/* IPV4套接字地址，32bit值.  */
typedef uint32_t in_addr_t;
struct in_addr
  {
    in_addr_t s_addr;
  };
  
/* 描述IPV4的套接字地址格式  */
struct sockaddr_in
  {
    sa_family_t sin_family; /* 16-bit */
    in_port_t sin_port;     /* 端口号  16-bit*/
    struct in_addr sin_addr;    /* Internet address. 32-bit */


    /* 这里仅仅用作占位符，不做实际用处  */
    unsigned char sin_zero[8];
  };
```


1. sin_family:和 sockaddr 一样，都有一个 16-bit 的 sin_family 字段，对于 IPv4 来说这个值就是 AF_INET
2. sin_port:接下来是端口号，我们可以看到端口号最多是 **16-bit**，也就是说最大支持 2 的 16 次方，这个数字是 65536，所以我们应该知道**支持寻址的端口号最多就是 65535**
3. sin_addr: 实际的 IPv4 地址是一个 32-bit 的字段，最多支持的地址数就是 2 的 32 次方，大约是 42 亿

##### IPv6 套接字地址格式

```c

struct sockaddr_in6
  {
    sa_family_t sin6_family; /* 16-bit */
    in_port_t sin6_port;  /* 传输端口号 # 16-bit */
    uint32_t sin6_flowinfo; /* IPv6流控信息 32-bit*/
    struct in6_addr sin6_addr;  /* IPv6地址128-bit */
    uint32_t sin6_scope_id; /* IPv6域ID 32-bit */
  };
```

整个结构体长度是 28 个字节，

1. sin6_flowinfo & sin6_scope_id: 这两个字段，一个在 glibc 的官网上根本没出现，另一个是当前未使用的字段
2. AF_INET6: 从 32 位升级到 128 位，这个数字就大到恐怖了，完全解决了寻址数字不够的问题。

##### AF_LOCAL

```c

struct sockaddr_un {
    unsigned short sun_family; /* 固定为 AF_LOCAL */
    char sun_path[108];   /* 路径名,最多108字节 */
};
```



## 地址
此文章为3月day5 学习笔记，内容来源于极客时间《[03丨套接字和地址：像电话和电话号码一样理解它们 (geekbang.org)](https://time.geekbang.org/column/article/113607)》，推荐该课程
