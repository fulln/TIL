#java #极客时间 #tcp 

# 15 | 怎么老是出现“地址已经被使用”？

### 地址被占用问题

#### TIME_WAIT

当连接的一方主动关闭连接，在接收到对端的 FIN 报文之后，主动关闭连接的一方会在 TIME_WAIT 这个状态里停留一段时间，这个时间大约为 2MSL

通过服务器端发起的关闭连接操作，引起了一个已有的 TCP 连接处于 TME_WAIT 状态，正是这个 TIME_WAIT 的连接，使得服务器重启时，继续绑定在 127.0.0.1 地址和 9527 端口上的操作，返回了 Address already in use 的错误。

#### 重用套接字

一个 TCP 连接是通过四元组（源地址、源端口、目的地址、目的端口）来唯一确定的，如果每次 Telnet 客户端使用的本地端口都不同，就不会和已有的四元组冲突，也就不会有 TIME_WAIT 的新旧连接化身冲突的问题

##### 现有系统进行的优化

1. 新连接 SYN 告知的初始序列号，一定比 TIME_WAIT 老连接的末序列号大，通过序列号就可以区别出新老连接。
2. 开启了 tcp_timestamps，使得新连接的时间戳比老连接的时间戳大，这样通过时间戳也可以区别出新老连接

在这样的优化之下，**一个 TIME_WAIT 的 TCP 连接可以忽略掉旧连接**，重新被新的连接所使用。

```c
重用套接字选项，通过给套接字配置可重用属性
int on = 1;
setsockopt(listenfd, SOL_SOCKET, SO_REUSEADDR, &on, sizeof(on));
```


#### 套接字选项

SO_REUSEADDR 套接字选项，允许启动绑定在一个端口，即使之前存在一个和该端口一样的连接。前面的例子已经表明，在默认情况下，服务器端历经创建 socket、bind 和 listen 重启时，如果试图绑定到一个现有连接上的端口，bind 操作会失败，但是如果我们在创建 socket 和 bind 之间，使用上面的代码片段设置 **SO_REUSEADDR** 套接字选项，情况就会不同。

**SO_REUSEADDR** 套接字选项还有一个作用，那就是本机服务器如果有多个地址，可以在不同地址上使用相同的端口提供服务。

### 最佳实践

服务器端程序，都应该设置 SO_REUSEADDR 套接字选项，以便服务端程序可以在极短时间内复用同一个端口启动。

有些人可能觉得这不是安全的。其实，单独重用一个套接字不会有任何问题，TCP 连接是通过四元组唯一区分的，只要客户端不使用相同的源端口，连接服务器是没有问题的，即使使用了相同的端口，根据序列号或者时间戳，也是可以区分出新旧连接的。


## 地址

此文章为3月day15 学习笔记，内容来源于极客时间《[15 | 怎么老是出现“地址已经被使用”？ (geekbang.org)](https://time.geekbang.org/column/article/131670)》，推荐该课程