#tcp #极客时间 

# 12 | 连接无效：使用Keep-Alive还是应用心跳来检测？

连接的一端需要一直感知连接的状态，如果连接无效了，应用程序可能需要报错，或者重新发起连接等。

### TCP Keep-Alive 选项
#### 机制
定义一个时间段，在这个时间段内，如果没有任何连接相关的活动，TCP 保活机制会开始作用，每隔一个时间间隔，发送一个探测报文，该探测报文包含的数据非常少，如果连续几个探测报文都没有得到响应，则认为当前的 TCP 连接已经死亡，系统内核将错误信息通知给上层应用程序。

分别被称为保活时间、保活时间间隔和保活探测次数。在 Linux 系统中，这些变量分别对应 sysctl 变量net.ipv4.tcp_keepalive_time、net.ipv4.tcp_keepalive_intvl、 net.ipv4.tcp_keepalve_probes，默认设置是 7200 秒（2 小时）、75 秒和 9 次探测。

### 如果开通保活，有以下场景

1. 对端程序正常工作，当 TCP 保活的探测报文发送给对端, 对端会正常响应，这样 TCP 保活时间会被重置，等待下一个 TCP 保活时间的到来。
2. 对端程序崩溃并重启，当 TCP 保活的探测报文发送给对端后，对端是可以响应的，但由于没有该连接的有效信息，会产生一个 RST 报文，这样很快就会发现 TCP 连接已经被重置
3. 是对端程序崩溃，或对端由于其他原因导致报文不可达。当 TCP 保活的探测报文发送给对端后，石沉大海，没有响应，连续几次，达到保活探测次数后，TCP 会报告该 TCP 连接已经死亡

**TCP 保活机制默认是关闭的**

### 自定义实现keep-alive

1. 实际上，对很多对时延要求敏感的系统中，这个时间间隔是不可接受的。

2. 可以通过在应用程序中模拟 TCP Keep-Alive 机制，来完成在应用层的连接探活。

3. 客户端，在保活时间达到后，发起对连接的 PING 操作，如果服务器端对 PING 操作有回应，则重新设置保活时间，否则对探测次数进行计数，如果最终探测次数达到了保活探测次数预先设置的值之后，则认为连接已经无效。

#### 关键点

第一个是需要使用定时器，这可以通过使用 I/O 复用自身的机制来实现；
第二个是需要设计一个 PING-PONG 的协议。

## 地址

此文章为3月day13 学习笔记，内容来源于极客时间《[12 | 连接无效：使用Keep-Alive还是应用心跳来检测？ (geekbang.org)](https://time.geekbang.org/column/article/127900)》，推荐该课程