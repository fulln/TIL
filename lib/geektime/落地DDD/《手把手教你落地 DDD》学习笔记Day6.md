#DDD #极客时间 

## 课程内容

### 用事务保护聚合

维护不变规则的第二种方式: 事务

#### 修改聚合对象

比较当前参数中的各个属性值。如果都相同，证明事实上不需要改变，所以什么都不需要做。只有当至少一个值不同时，才对对象进行修改。修改属性值后，聚合根方法来改变修改状态(ChangingStatus)。

#### 修改聚合的应用服务
```java
private final EmpUpdator updator; //用于修改Emp聚合
```
调用 updator 来对聚合进行更新，最后调用仓库把聚合保存到数据库

	 Updator 是我们新写的一个类，在地位上和 Assembler 是类似的，都是应用服务的 Helper。本来 Updator 的逻辑也可以写在 Assembler 里，但这样 Assembler 就过于庞大了，所以基于关注点分离的原则，我们单独写一个 Updator 来完成修改功能。

#### 聚合的查询

由于聚合在逻辑上是一个整体，并且采用了在聚合内部用对象导航的策略，所以会把实体和从属都一次性取到内存。当我们调用domain 的一些方法赋值的时候，会触发业务规则的校验,所以在查询时是否需要校验.

##### 怎么样绕过业务限制

1. 先把 domain 中的属性都改成 protected 的，然后写一个 domain 的子类，这个子类中的方法也可以设置 domain 的值，但是不调用业务规则，这样就达到了绕过业务规则的目的。

#### 修改聚合的持久化

根据domain对象的修改状态（changingStatus），来插入或更新表

#### 保证固定规则

仅仅靠数据库事务，是无法完成这一任务的，需要自己编写一些代码来完成。这种比数据库事务“高一级”的事务，我们可以称为“业务事务”（Business Transaction）。业务事务一般要使用乐观锁或者悲观锁的机制。

- 乐观锁
	- 在聚合根的代码和数据表里增加一个版本（version）字段

#### 单实体聚合

有些实体，既不是聚合根，也不从属于任何聚合,组织实体就构成了一个单实体聚合，它本身就是聚合根，在代码层面可以和普通聚合一样处理


## 课程地址

>《手把手教你落地 DDD》学习笔记Day6
> https://time.geekbang.org/column/article/622338