#设计思想 #DDD #极客时间 

## 29｜限界上下文（中）：限界上下文怎样影响架构设计？

### 建模上下文

需要保持对应上下文的泛化

通过聚焦“项目”上下文的设计，不受其他上下文概念的干扰，我们得到了一个更加简洁和灵活的设计。



### 架构设计

微服务与单体服务的对比

- 第一，收益大于成本。使用微服务的好处包括容易横向扩容、独立部署、避免系统腐化等等。代价是提高了运维的成本、远程调用增加了性能损耗以及维护最终一致性的复杂性等等。只有在收益大于成本的情况下，才值得使用微服务。
- 第二，只有在团队有足够的运维技能和基础设施支持的时候，才能使用微服务。
- 第三，只有团队具有一定的开发微服务的技能和经验时，才能使用微服务。


### 微服务的设计理念

设计微服务，我们可以先假定每个限界上下文对应一个微服务。然后，再综合考虑多方面的因素，决定是否需要进一步细分。下面是几种常见的情况。

- 第一，不同的可伸缩性要求。如果一个上下文里有些部分，需要随着使用情况，动态部署到更多的容器
- 第二，不同的安全性要求。比如说，有些功能要接入互联网，有些部分在内网用，需要部署在防火墙的不同位置。这时候，也需要划分成不同的微服务。
- 第三，技术异构性。比如说，有些部分需要用 Java 开发，有些部分需要用 node.js 开发，这时候，也要分成不同的微服务了。

### 为什么要根据限界上下文设计微服务

可以从功能性需求和非功能性需求两方面考虑。


根据限界上下文来划分模型，既考虑到了传统模块化思维中对业务概念的松耦合、高内聚的要求，又考虑到团队的认知负载和认知边界。

从功能性方面考虑，微服务的划分应该有利于保证系统概念的一致性，更容易灵活扩展功能，而这些又要求开发团队顺畅的沟通协作。

合理的微服务划分，应该是对于多数需求变更，只需改动一个或少量的微服务。而划分不合理的话，对于多数业务需求，都要修改多个微服务。有人把这种现象叫做“分布式单体”，这其实也是因为模型划分不合理，没有找到内聚的业务边界。而限界上下文可以解决这个问题。

限界上下文为微服务的划分奠定了基础。然后，就可以再考虑性能、安全、可用性等非功能性需求，看是不是需要进一步划分

### 限界上下文的集成

#### 对应集成策略

1. 数据同步
2. api调用策略

#### 实现策略

1. 一种是同步调用。“项目管理”新增一个项目，“项目管理”服务就会调用“工时管理”服务中的一个“新增工时项”接口，“项目管理”服务会等待这个成功信息，收到以后，才会继续处理其他逻辑。
2. 异步调用。“项目管理”新增项目以后，会向消息中间件发送一个“项目已增加”的事件，然后不用等待，继续进行其他处理

不论采用哪种策略，概念层面的映射关系都是一样的，只是实现层面不同。不同的实现策略，可以根据性能、时效性、技术复杂度、数据可靠性等多个维度进行权衡。

### 防腐层

Repository 并不直接访问数据库，而是访问另一个上下文的 Service。不过，对于 EffortItemService 来说，它并不需要知道仓库是怎么实现的,它只知道，要调用仓库取一个实体，所以，仍然命名为 Repository

DDD 中，防腐层也是一种用于上下文映射的模式。指的是两个上下文之间的转换逻辑，这个逻辑可以屏蔽两个上下文的差异，从而使两个上下文可以相对独立地演进。我们目前采用的方法是让适配器充当防腐层。


### 战略设计和战术设计

不过按一般人的思维，有了战略，自然要有“战术”。所以后来有的书就提出了“战术设计”这个词。大体上，不是战略的部分就属于战术了。

- 首先，战略设计和战术设计中的“设计”应该指广义的设计，而不是和“分析”相对的软件设计。
- 所谓战术设计，就是细粒度的建模，包括实体、值对象、关联、模块、聚合等等。而战略设计，解决的是当系统变得很大很复杂的时候，怎样从宏观上把握系统的总体结构，应对系统的规模和复杂性的问题。
- 我们的课程中讲的限界上下文，就是一种在宏观上分而治之的手段。

## 地址

此文章为2月day20 学习笔记，内容来源于极客时间《[29｜限界上下文（中）：限界上下文怎样影响架构设计？ (geekbang.org)](https://time.geekbang.org/column/article/631500)》,《[30｜限界上下文（下）：限界上下文之间如何集成？ (geekbang.org)](https://time.geekbang.org/column/article/632219)》