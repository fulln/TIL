---
dg-publish: true
title: # 如何构建分布式的消息队列集群
createTime: 2023-08-27 23:47  
---

# 如何构建分布式的消息队列集群


### 设计实现集群化的消息队列

节点发现、节点探活、元数据存储、集群管理四个方面。

#### 有状态服务和无状态服务
二者之间最重要的一个区别在于：是否需要在本地存储持久化数据。需要在本地存储持久化数据的就是有状态服务，反之就是无状态服务。

> 有状态服务和无状态服务构建集群的思路是完全不一样的。HTTP Web 服务就是典型的无状态服务。在搭建 HTTP Web 集群的时候，我们经常会使用 Nginx 或者在其他网关后面挂一批 HTTP 节点，此时后端的这批 HTTP 服务节点就是一套集群。

消息队列是有状态服务。消息是和分片绑定，分片是和节点绑定。所以，当需要发送一个消息后，就需要发送到固定的节点，如果把消息发送到错误的节点，就会失败

#### 消息队列的集群设计思路

一般都是基于主从（Master/Slave）思想来设计的。即通过一个组件来管理整个集群的相关工作，比如创建和删除主题、节点上下线等等。这个组件一般叫做 Master（主节点）或 Controller（控制器）。
![](https://static001.geekbang.org/resource/image/ee/de/ee8db4ceda999771fd0d89d0805626de.jpg?wh=10666x4801)


##### 元数据存储

元数据是指集群中 **Topic、分区、配置、节点、权限等信息**。元数据必须保证可靠、高效地存储，不允许丢失。因为一旦元数据丢失，其实际的消息数据也会变得没有意义。

主要实现方式为：

1. 依赖第三方存储引擎,比如 ZooKeeper、etcd、单机或者分布式数据库等等。
2. 集群内部自实现存储,Kafka 去 ZooKeeper 后的 KRaft 架构中的元数据存储，就是基于这个思路实现的。

##### 节点发现
所有节点知道对方的存在或者有一个组件知道所有节点的存在，这样才能完成后续的集群管理和调度。

实现手段
1. 配置文件是指通过配置文件配置所有节点 IP，然后节点启动后根据配置文件去找到所有的节点，从而完成节点发现。
2. 类广播机制是指通过广播、DNS 解析等机制，自动去发现集群中所有节点。比如通过解析 DNS 域名，得到域名绑定的所有 IP，从而发现集群中所有节点。
3. 集中式组件是指所有节点都向集中式组件去注册和删除自身的节点信息，此时这个组件就会包含所有节点的信息，从而完成节点发现。

##### 节点探活
一般需要有一个角色来对集群内所有节点进行探活或者保活，这个角色一般是主节点（Master/Leader/Controller）或第三方组件。

**技术上一般分为主动上报和定时探测两种，这两种方式的主要区别在于心跳探活发起方的不同**

> 从技术和实现上看，差别都不大，从稳定性来看，一般推荐主动上报。因为由中心组件主动发起探测，当节点较多时，中心组件可能会有性能瓶颈，所以目前业界主要的探活实现方式也是主动上报。




# 地址

此文章为8月day27 学习笔记，内容来源于极客时间《https://time.geekbang.org/column/article/677936》