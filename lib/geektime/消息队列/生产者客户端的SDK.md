---
dg-publish: true
title: 生产者客户端的SDK
createTime: 2023-08-03 23:53  
---

## 生产者客户端的SDK

生产模块包含客户端基础功能和生产相关功能两部分，其中基础功能是客户端中所有功能共用的。

![](https://static001.geekbang.org/resource/image/c7/61/c7b6ce167752520263ea3c404d2c6561.jpg?wh=3228x1488)


### 客户端基础功能

#### 连接管理

每个客户端实例和borker只会维护一条TCP连接，等待数据发送

1. 初始化创建连接，在实例初始化的时候就创建到各个Broker的Tcp连接，等待数据发送
2. 使用时创建连接，在实例初始化不创建连接，需要发送时再建立。

从资源利用角度看，使用**晚建立连接的方式**较好

- 单个 TCP 连接发送性能存在上限，我们就需要在客户端启动多个生产者，提高并发读写的能力。一般情况下，每个生产者会有一个唯一的 ID 或唯一标识来标识客户端，比如 ProduceID 或客户端的 IP+Port。

#### 心跳检查

心跳检测是客户端和服务端之间保活的一种机制，检测服务端或者客户端的一方不可用时，另一方可以及时回收资源，避免资源浪费。一般通过 ping-pong 的方式来发起探测

探测机制实现：
1. 基于TCP的KeepAlive保活机制
	1. 需要server主动发出检测包，可能出现很多不可用连接
2. 应用层主动探测
	1. 主要解决灵活性和KeepAlive的缺点
	2. 当连续多次没受到请求，就断开连接

> NETTY 的心跳探测机制
![](https://static001.geekbang.org/resource/image/a0/9b/a0c19fb2edf238b13250ac44dfd5949b.png?wh=1018x203)
#### 错误处理

从请求的角度，有些错误是重试可以恢复的，比如连接断开、Leader 切换、发送偶尔超时、服务端某些异常等；有些错误是不可恢复的，比如 Topic/ 分区不存在、服务端 Broker 不存在、集群和 Broker 长时间无响应等。

因为网络环境、架构部署的复杂性，集群可能出现短暂网络抖动、Leader 切换等异常，可重试错误就是这类通过一次或多次重试可能恢复的异常；不可重试的错误就是不管如何重试都无法恢复的异常。

在客户端 SDK 的实现过程中，错误处理是一个包含很多细节的工作，一般需要考虑下面几个点。
- 如何定义可恢复错误和不可恢复错误。
- 完整的错误码的定义和枚举，好的错误码定义可以提高排查问题的效率。
- 错误后重试的代码实现方式是否合理高效。
- 判断哪些情况需要停止客户端，向上抛错，以免一些错误信息一直在 SDK 内空转，提高上层感知异常和排查异常的难度。
- 日志信息打印 debug、info、error 日志时，是否包含了完整的内容。
#### 重试机制

当出现错误时，就会根据退避策略退避，再尝试写入。一般情况下，重试是有次数上限的，当然也支持配置无限重试。

因为网络抖动正常是 ms 级，某些异常可能会抖动十几秒。此时，如果退避策略设置得太短，在退避策略和重试次数用完后，可能消息还没生产成功；如果退避时间设置太长，可能导致客户端发送堵塞消息堆积。

### 生产相关功能
#### 客户端寻址机制

1. Metadata（元数据）寻址机制
>服务端会提供一个获取全量的 Metadata 的接口，客户端在启动时，首先通过接口拿到集群所有的元数据信息，本地缓存这部分数据信息。然后，客户端发送数据的时候，会根据元数据信息的内容，得到服务端的地址是什么，要发送的分区在哪台节点上。最后根据这两部分信息，将数据发送到服务端。

客户端一般通过定期全量更新 Metadata 信息和请求报错时更新元数据信息两种方式，来保证客户端的元数据信息是最新的


2.  服务端内部转发机制

客户端不需要经过寻址的过程，写入的时候是随机把数据写入到服务端任意一台 Broker。

>服务端的每一台 Broker 会缓存所有节点的元数据信息，生产者将数据发送给 Broker 后，Broker 如果判断分区不在当前节点上，会找到这个分区在哪个节点上，然后把数据转发到目标节点。

但是生产流程多了一跳，耗时增加了。另外服务端因为转发多了一跳，会导致服务端的资源损耗多一倍，比如 CPU、内存、网卡，在大流量的场景下，这种损耗会导致集群负载变高，从而导致集群性能降低。

#### 生产分区分配策略

消息队列默认支持轮询、按 Key Hash、手动指定、自定义分区分配策略四种分区分配策略。

#### 批量语义

批量发送的实现思路一般是在客户端内存中维护一个队列，数据写入的时候，先将其写到这个内存队列，然后通过某个策略从内存队列读取数据，发送到服务端。


>批量发送数据的策略和存储模块的刷盘策略很像，都是根据数据条数或时间聚合后，汇总发送到服务端，一般是满足时间或者条数的条件后触发发送操作，也会有立即发送的配置项。
>
>Kafka 是按照时间的策略批量发送的，提供了 linger.ms、max.request.size、batch.size 三个参数，来控制数据的批量发送。linger.ms：设置消息延迟发送

#### 数据发送方式

同步和异步更多是语言语法的实现，同步发送主要解决数据发送的即时性和顺序性，异步发送主要考虑性能。发送即忘可能不好理解，我们重点讲下。

>发送即忘指消息发送后不关心请求返回的结果，立即发送下一条。这种方式因为不用关心发送结果，发送性能会提升很多。缺点是当数据发送失败时无法感知，可能有数据丢失的情况，所以适合用在发送不重要的日志等场景。Kafka 提供了 ack=0、RocketMQ 提供了 sendOneway 来支持这种模式。

#### 集群管控操作

用来完成资源的创建、查询、修改、删除等集群管理动作。资源包括主题、分区、配置、消费分组等等。命令行工具是最基本的支持方式。如下图所示，它的底层主要通过包装客户端 SDK 和服务端的相关功能接口进行交互。程序编码上一般由命令行、参数包装、底层 SDK 调用三部分组成。主要流程是接收参数、处理参数、调用 SDK 等相关操作。


# 地址

此文章为8月day3 学习笔记，内容来源于极客时间《https://time.geekbang.org/column/article/672868》