---
dg-publish: true
title: 怎么在 Kafka 上支持延迟消息
createTime: 2023-08-11 23:22  
---
# 怎么在 Kafka 上支持延迟消息

## 延迟队列和延迟消息

它里面的每个元素都有一个过期时间，当元素还没到过期时间的时候，如果你试图从队列里面获取一个元素，你会被阻塞。当有元素过期的时候，你就会拿到这个过期的元素

1. RabbitMQ
rabbitmq_delayed_message_exchange，只需要启用这个插件就可以使用延迟消息。这个插件的基本原理也比较简单，就是实现了一个 exchange。这个 exchange 控制住了消息什么时候会被真的投递到队列里。

### 利用定时任务调度

最简单的做法就是利用定时任务，最好是解决了持久化的分布式任务平台。那么业务发送者就相当于注册一个任务，这个任务就是在 30 分钟之后发送一条消息到 Kafka 上。之后业务消费者就能够消费了。
### 分区设置不同延迟时间

delay_topic 里面的分区被用来接收不同延迟时间的消息。比如说在上图中分成了 p0、p1、p2 三个分区，分别用于接收延迟时间为 1min、3min 和 10min 的消息。

延迟消费组会创建出和分区数量一样的消费者，每一个消费者消费一个分区。消费者每次读取一个消息，等延迟足够长的时间之后，就会转发给 biz_topic。
### 一致性问题

如果先转发 biz_topic，然后提交。那如果提交之前宕机了，后面恢复过来，又会转发一次。好在多发一次并不是什么问题，因为你可以要求业务消费者确保自己的逻辑是幂等的

致性的问题解决起来需要业务方的配合。我们这个的逻辑是到了延迟时间，就先转发 biz_topic，然后再提交。也就是说，如果在转发 biz_topic 之后，提交失败了，下一次就还可以重试，那么 biz_topic 就可能收到两条同样的消息。在这种场景下，就只能要求消费者做到幂等。当然，即便不用延迟消息，消费者最好也要做到幂等的。因为发送方为了确保发送成功，本身就可能重试。

### 基于 MySQL 的亮点方案

务发送者把消息发送到这个 topic 里面，消息里面带上了需要延迟的时间。里面有一个延迟消费者，它会消费 delay_topic 里面的消息，转储到数据库中。还有一个延迟发送者，它会轮询数据库里的消息，把已经可以转发出去的消息转发到真正的 biz_topic 上。发送完之后，延迟发送者把数据库的状态更新成已发送。最后业务消费者消费 biz_topic。

## 面试思路总结

利用定时任务调度和分区设置不同延迟时间。在为分区设置不同的延迟时间时，你要注意 rebalance 和一致性的问题。


# 地址

此文章为8月day11 学习笔记，内容来源于极客时间《https://time.geekbang.org/column/article/685187》