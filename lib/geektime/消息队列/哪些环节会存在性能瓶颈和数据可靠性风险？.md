---
dg-publish: true
title: 哪些环节会存在性能瓶颈和数据可靠性风险？
createTime: 2023-08-17 23:31  
---


# 哪些环节会存在性能瓶颈和数据可靠性风险？

![](https://static001.geekbang.org/resource/image/d9/70/d9a28a4716af2f6087a7a99b84af1270.jpg?wh=10666x6000)
### 消息队列集群中哪些环节可能存在性能瓶颈和可靠性风险


#### 生产者的性能和可靠性
![](https://static001.geekbang.org/resource/image/81/32/8153ee8a8877affd9db7781b08de0632.jpg?wh=10666x3098)
##### 网络层面

在网络层面，对性能和可靠性的影响主要包括连接协议、传输加密、网路稳定性、网络延时、网络带宽五个方面。

>生产者客户端会先和 Broker 建立并保持 TCP 长连接，而不是在每次发送数据时都重新连接，以确保通信的性能。

1. 在数据传输过程中，为了避免数据包被篡改、窃取，就需要进行传输加密。
	1. 因为网络质量不稳定，传输过程中可能也存在丢包的情况，此时就需要依赖 TCP 的重传机制来解决问题。但当出现大量网络重传时，就会极大地影响性能，导致集群的吞吐下降和耗时上升。这也是我们在系统运营过程需要监控网络包重传率的原因。
	2. 当启用加密传输后，数据的传输性能会下降
2. 在性能部分，客户端和服务端的网络耗时是绕不过去的。特别在流量大、高吞吐的场景下，网络耗时对数据传输性能的影响更大。
3. 在客户端的部署上，为了保证延时和吞吐，就需要尽量将客户端和服务端部署在同一个可用区内网中，以避免网络链路带来的影响。
4. 客户端和 Broker 的网卡使用情况比较好发现和分析，经常忽略且不容易分析的是中间网络带宽的使用情况，比如在跨地域传输、跨云传输的场景下，中间网络带宽很容易成为瓶颈。


##### SDK 层面

在 SDK 层面，对性能和可靠性的影响主要包括**发送模式、批量语义、异常处理、生产者数量四个方面。**


1. 生产端，一般支持发送即忘、同步发送、异步发送三种发送模式，发送模式的设计思想是希望在性能和可靠性之间寻找平衡。
	1. 发送即忘是指调用 send() 函数后，不用等待服务端的返回结果，因此可以不断地发送数据。这种模式的性能是最高的，可靠性是最低的，因为数据发送失败后没有任何后续的容错处理。
	2. 同步发送是指调用 send() 函数后，业务代码同步等待服务端的返回，优点是能保证发送消息的顺序性，这种模式的性能是最低的。其性能高度依赖 Broker 和服务端之间的网络延时，以及 Broker 的处理耗时。
	3. 异步发送是指调用 send() 函数后，使用异步线程回调的方式发送数据。即在不阻碍主线程的情况下发送数据，此时业务可以一直不停地发送数据。但是如果 send() 速度大于底层发送给 Broker 的速度，当 SDK 底层的线程池用完后，发送数据也会阻塞。









# 地址

此文章为8月day17 学习笔记，内容来源于极客时间《https://time.geekbang.org/column/article/677197》