---
dg-publish: true
title: 如何设计高性能的网络模块
createTime: 2023-08-04 23:33  
---

## 网络：如何设计高性能的网络模块

对消息队列来说，网络模块是核心组件之一，网络模块的性能很大程度上决定了消息传输的能力和整体性能

>消息队列是需要满足高吞吐、高可靠、低延时，并支持多语言访问的基础软件，网络模块最需要解决的是性能、稳定性、开发成本三个问题。接下来我们就围绕这三点来思考消息队列网络模块应该怎样设计。

### 网络模块的性能瓶颈分析

![](https://static001.geekbang.org/resource/image/a8/98/a831a39cd1bf783665eb844257c69898.jpg?wh=3228x1488)

对于单个请求来说，请求流程是：客户端（生产者 / 消费者）构建请求后，向服务端发送请求包 -> 服务端接收包后，将包交给业务线程处理 -> 业务线程处理完成后，将结果返回给客户端。其中可能消耗性能的有三个点。

1. 编解码的速度
2. 网络延迟
3. 服务端/客户端网络模块的处理速度


对于并发请求，单个请求维度的问题上，需要处理高并发，高QPS，高流量等场景，主要包含3个方面

1. 高效的连接管理，当客户端和服务端之间的 TCP 连接数很多，如何高效处理、管理连接。
2. 快速处理高并发请求，当客户端和服务端之间的 QPS 很高，如何快速处理（接收、返回）请求。
3. 大流量场景，当客户端和服务端之间的流量很高，如何快速吞吐（读、写）数据。

### 高性能网络模块的设计实现

#### 基于多路复用技术管理 TCP 连接

1. 单条 TCP 连接的复用
2. IO 多路复用技术
	1. 过把多个 IO 的阻塞复用到同一个 selector 的阻塞上，让系统在单线程的情况下可以同时处理多个客户端请求。最大的优势是系统开销小，系统不需要创建额外的进程或者线程，降低了维护的工作量，也节省了资源。
	2. 单机能处理的连接数还是有上限的
		1. 第一个上限是操作系统的 FD 上限，如果连接数超过了 FD 的数量，连接会创建失败
		2. 第二个限制是系统资源的限制，主要是 CPU 和内存。频繁创建、删除或者创建过多连接会消耗大量的物理资源，导致系统负载过高。
```shell
//查看能打开FD的数量 
ulimit -n //用户级限制
cat /proc/sys/fs/file-max  //系统级限制

//临时修改最大数量 
ulimit -n 100000 //将最大值改为100000
```

#### 基于 Reactor 模型处理高并发请求


# 地址

此文章为8月day4 学习笔记，内容来源于极客时间《https://time.geekbang.org/column/article/670965》