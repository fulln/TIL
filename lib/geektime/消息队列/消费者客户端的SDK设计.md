---
dg-publish: true
title: 消费者客户端的SDK设计
createTime: 2023-08-05 22:49  
---

# 消费者客户端的SDK设计

消费相关功能包括**消费模型、分区消费模式、消费分组（订阅）、消费确认、消费失败处理五个部分**
## 消费模型

### 1. PULL 模型

- 好处是客户端根据自身的处理速度去拉取数据，不会对客户端和服务端造成额外的风险和负载压力。
- 缺点是可能会出现大量无效返回的 Pull 调用，另外消费及时性不够，无法满足一些需要全链路低耗时的场景。

**Pull 模型都会支持批量读，即在客户端指定需要拉取多少条数据或者拉取多大的数据，然后传递给服务端**

#### 如何规避问题

1. 服务端hold住请求
> 当客户端根据策略拉取数据时，如果没有足够的数据，就先在服务端等一段时间，等有数据后一起返回给客户端。
>  
>  1. 好处是，可以尽量提高吞吐能力，不会有太多的空交互请求
>  2. 坏处是，如果长时间不给客户端回包，会导致客户端请求超时，另外当数据不够时，hold 住请求的时间太长就会提高消费延时

2.  服务端有数据通知到客户端
> 当服务端不 hold 住请求，立刻返回空数据，客户端收到空数据时则不再发起请求，会等待服务端的通知
>当服务端有数据的时候，再主动通知客户端来拉取。

在 Pull 模型中，**比较合适的方案是客户端告诉服务端：最多需要多少数据、最少需要多少数据、未达到最小数据时可以等多久三个信息**

>服务端首先判断是否有足够的数据，有的话就立即返回，否则就根据客户端设置的等待时长 hold 住请求，如果超时，无论是否有数据，都会直接给客户端返回当前的结果。

>这种策略可以解决频繁不可控的空轮询请求。即使全是空轮询，对单个消费者来说，其 TPS 也是可以预估的，即总时间 / 等待时长 = 总轮询次数。而如果需要降低消费延时，可以通过降低最小获取的数据大小和最大等待时长来提高获取的频率，从而尽量降低延时。

### Push 模型

当服务端有数据时会主动推给客户端，让数据的消费更加及时。





# 地址

此文章为8月day5 学习笔记，内容来源于极客时间《https://time.geekbang.org/column/article/673672》