---
dg-publish: true
title: 如何提升存储模块的性能和可靠性
createTime: 2023-08-01 23:36  
---
## 如何提升存储模块的性能和可靠性

### 存储性能优化有关的基础理论

- 内存读写的效率高于硬盘读写
- 批量读写的效率高于单条读写
- 顺序读写的效率高于随机读写
- 数据复制次数越多，效率越低

#### 缓存写和批量写

优化主要思路： **写到内存，等积攒了一批数据，在批量刷到硬盘**

##### 缓存写盘的主要策略

1. 按空间占用比例刷新
	1. 当内存系统的脏数据大于阈值，将数据刷新到硬盘
2. 按时间周期刷新
	1. 脏页存活时间（dirty_expire_seconds) 和刷新周期（dirty_writeback_centisecs）两个参数来配置
3. 程序手动刷新
	1. 手动调用fsync()

#### 随机写和顺序写

**顺序读写效率高于随机读写**
是针对硬盘的，是整个操作系统和硬盘的关系，而不是单文件和硬盘的关系。

##### 单文件写入和多文件顺序写入
多文件顺序写入，从硬盘角度看，就是随机写入

_**随机写和顺序写的核心就是数据存储结构的设计。**_


市面上2种方案：
1. 每个 Partition/Queue 单独一个存储文件，
2. 每台节点上所有 Partition/Queue 的数据都存储在同一个文件。
第一种方案，对单个文件来说读和写都是顺序的，性能最高，但当文件很多且都有读写，在硬盘层面就会退化为随机读写，性能会下降很多。第二种方案，因为只有一个文件，不存在文件过多的情况，写入层面一直都会是顺序的，性能一直很高。所以为了提高写的性能，我们最好使用第二种方案。

### 提高写入的可靠性

在消息队列的存储模块中，一般会通过三种处理手段：同步刷盘、WAL 预写日志、多副本备份，进一步提升数据的可靠性
#### 同步刷盘
每条数据都同步刷盘，等于回到了直接写硬盘的逻辑，一般通过写入数据后调用 force() 操作来完成数据刷盘。这种方案无法利用内存写入速度的优势，效率会降低很多。

#### WAL
写数据之前先写日志，当出现数据丢失时通过日志来恢复数据，避免数据丢失。

> 在实际落地中，我们可以采取 WAL 日志盘和实际数据盘分离的策略，提升 WAL 日志的写入速度。具体就是让 WAL 数据盘是高性能、低容量的数据盘，数据盘是性能较低、容量较大的数据盘，如果出现数据异常，就通过 WAL 日志进行数据恢复。这样，给 WAL 日志选择合适的设备，再加上并行读写等代码优化手段，性能损失就可控了，甚至可以忽略。

#### 多副本备份
将数据拷贝到多台节点，每台节点都写入到内存中，从而完成数据的可靠性存储



### 提升读取操作的性能

提高读取的性能主要有读热数据、顺序读、批量读、零拷贝四个思路。

#### 冷读和热读
热读是指消息数据本身还在缓存中，读取数据是从内存中获取，此时性能最高，不需要经过硬盘。冷读是指消息数据刷到硬盘中了，并且数据已经被换页换出缓存了，此时读取数据需要从硬盘读取。

#### 顺序读、随机读、批量读

在消费的时候服务端都会支持批量读的能力。为了能尽快返回数据给客户端，服务端都会实现数据的预读机制。在读取数据的时候，也读取客户下一步可能会用的数据，预先加载到内存中，以便更快返回数据。

方案一在读取的过程中，因为数据是连续存储的，数据预读非常方便，只要在硬盘上读取连续的数据块即可，不需要在程序上做逻辑处理，性能最高。

方案二需要根据分区上的数据索引，在具体存储文件的不同位置读取数据。数据可能是连续的，也可能是不连续的。这种情况下硬盘的预读就很有随机性，大部分情况下在硬盘看来就是随机读。性能比第一种方案低。
#### 零拷贝原理和使用方式
![](https://static001.geekbang.org/resource/image/80/d7/80ecda9234bcc260018618a578ea6cd7.jpg?wh=2737x1782)


**主要思路是通过减少数据复制次数、减少上下文（内核态和用户态）切换次数、通过 DMA（直接内存）代替 CPU 完成数据读写，来解决复制和资源损耗的问题。**

零拷贝主要用于在消费的时候提升性能，具体有两种实现方式：mmap+write 和 sendfile

> mmap 是一种内存映射文件的方法，把文件或者其他对象映射到进程的地址空间，修改内存文件也会同步修改，这样就减少了一次数据拷贝。所以，我们不需要把数据拷贝到用户空间，修改后再回写到内核空间。

>sendfile，是指 Linux 内核提供的一个系统调用 sendfile() ，它可以将数据从一个文件描述符传输到另一个文件描述符。之前图中的红色线路就是通过 senfile 系统调用和 DMA 技术，将四次的数据复制次数变为了两次，提高了性能。

几乎所有的消息队列在消费时都使用了 sendfile 的调用，因为它配合 DMA 技术至少可以提升一倍的消费速度。

### 硬件性能提升

1. 多盘读写
2. 配置 RAID 和 LVM 硬盘阵列


## 地址

此文章为8月day1 学习笔记，内容来源于极客时间《https://time.geekbang.org/column/article/672152》