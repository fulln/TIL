---
dg-publish: true
title: 安全：如何设计高吞吐和大流量分布式集群的限流方案？
createTime: 2023-09-12 23:19
tags:
  - kafka
  - rocketqm
---
# 安全：如何设计高吞吐和大流量分布式集群的限流方案？
消息队列系统安全的第二部分：数据自我保护和服务自我保护。

- 数据维度的自我保护主要指如何保证服务端数据的安全，不被窃取。
- 服务维度的自我保护主要指集群的限流机制，通过限制客户端的流量、请求、连接等保护自身不被击垮。

## 集群中的数据加密

当客户端发送消息 A（比如 hello world）到 Broker，Broker 保存到磁盘的数据是一串内容 A 加密后的字符串，当消费端消费数据时，Broker 将加密后的字符串解密成消息 A 返回给消费端。

#### 实现这个效果一般有以下两种方案：

1. 由服务端自动化做好加密解密。工作量全在服务端，客户端没有任何工作量。
2. 客户端在生产的时候自助做好加密逻辑，在消费的时候自助做好解密操作。好处在于消息队列服务端没有任何工作量，坏处在于工作量全部在客户端，所有的客户端和消费端都需要感知加密的逻辑，在编码和协调各方的成本方面较高。

不过目前业界主流开源消息产品都是不支持消息加密的，我们无法用第一个方案，但一些闭源的商业化消息队列产品具备这个能力

##### 如果需要第一种方案，技术上要怎么实现呢？

主要分为三步

1. 首先，把接收到的数据解析为生产端发送出来的原始消息格式。需要解析是因为客户端可能设置了批量发送、压缩等行为，导致服务端收到的格式和原始的消息不一致。
2. 其次，对这些消息进行加密，并存储到磁盘。
3. 最后，在客户端消费数据时，把加密的消息解密成为原始接收到的消息格式返回给客户端。



# 地址

此文章为9月day12 学习笔记，内容来源于极客时间《https://time.geekbang.org/column/article/684256》