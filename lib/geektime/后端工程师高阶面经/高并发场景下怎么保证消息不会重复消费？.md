---
dg-publish: true
title: 高并发场景下怎么保证消息不会重复消费
createTime: 2023-08-18 22:42  
---


# 高并发场景下怎么保证消息不会重复消费？

### 布隆过滤器
布隆过滤器（Bloom Filter）是一种数据结构，它可以用于检索一个元素是否在一个集合里。它的优点是空间效率和查询时间都远远超过一般的算法，缺点是存在假阳性的问题，还有对于删除操作不是很友好。

#### bitMap 效果更好
用一个比特位来代表元素是否存在，1 代表存在，0 代表不存在。它和布隆过滤器的核心区别是它不需要哈希函数，因为它的值本身就是一个数字。比如说，你的用户 ID 是数字，那么你就可以把 ID 当成 bit array 的下标，对应位置的比特位是 1。

**bit array 不存在假阳性的说法，它的判断是精确的。**
### 重复消费的可能原因

**一定要把消费逻辑设计成幂等的。** 你的微服务也要尽可能设计成幂等的，这样上游就可以利用重试来提高可用性了。另外我要说明一点，现在大多数消息中间件都声称自己实现了恰好一次（exactly once）语义，都是依赖于重试和幂等来达成的。
## 常见问题

- 你负责的业务里面有没有接口或消费者是要求幂等的？如果有，你是如何解决幂等的？
- 如果你依赖于唯一索引来解决幂等，那么这部分的写流量有多大？
- 如果你依赖于唯一索引来解决幂等，那么你是怎么保证业务操作和将数据插入到唯一索引是同时成功，或者同时失败的？
- 你或者你的同事有没有因为没有设计幂等，或者幂等方案有问题而引起线上事故？如果有，你是怎么解决的？
- 你的业务是否使用过布隆过滤器，如果有，当时用来解决什么问题？

### 基本思路

#### 1. 本地事务将数据插入到唯一索引
>收到消息之后就开启一个本地事务。在这个本地事务里面你会同时完成业务操作和将数据插入到唯一索引这两个操作，然后提交。

>把唯一索引和业务操作组合在一起，做成一个事务。也就是在收到消息的时候先开启事务，把数据插入到唯一索引，然后执行业务操作，最后提交事务。提交事务之后，就认为业务已经成功了，就算接下来提交消息失败了也没关系，因为后面重复请求还是会被唯一索引拦下来。

#### 2. 非本地事务将数据插入到唯一索引
>业务操作和将数据插入到唯一索引的操作就不能看作是一个整体，无法保证要么都成功，要么都失败。这时候，只能追求最终一致性，依赖于一个第三方来检测了。

1. 把数据插入到唯一索引，但是这个时候状态被标记为初始状态。注意这一步一定要先执行，这是避免重复处理的关键。
2. 执行业务操作。
3. 将唯一索引对应的数据标记为完成状态。

#### 3. 布隆过滤器 + Redis + 唯一索引

布隆过滤器就非常适合用来解决这个问题。但是布隆过滤器本身存在假阳性的问题。也就是说，一个消息明明没有被处理过，但是布隆过滤器可能误报你处理过了。所以我们可以在布隆过滤器之后再加一个 Redis，存储近期处理过的业务 key。
#### 4. 更新顺序
先更新数据库的唯一索引，因为数据库里的数据是最准确的。

可以说这个方案最终都是要依靠唯一索引来兜底的。也就是说不管什么原因导致布隆过滤器或者 Redis 没生效，只要跑到了插入唯一索引这一步，都可以确保你最终不会重复处理消息或者请求。

##### Redis key 的过期时间

>Redis 的作用就是在布隆过滤器之后进一步削减流量，而 key 的过期时间就决定了削减流量的效果，所以只需要确保重复请求过来的时候，这个 key 还没过期就可以了。

如果说业务并发不是特别高，或者说不想用这么复杂的方案，那么可以考虑使用简化方案。

第一种简化方案就是只用布隆过滤器和唯一索引。如果 Redis 资源不足，又或者重复请求间隔太长，导致使用 Redis 的效果不好，那么就比较适合用这个简化方案。

第二种简化方案就是只用 Redis 和唯一索引。Redis 资源多，又或者担心布隆过滤器的假阳性问题，就可以采用这个方案。

#### 5. 本地布隆过滤器。

> 在性能要求非常苛刻的情况下，可以考虑使用本地布隆过滤器，但是这要和负载均衡结合在一起使用。比如说在消息消费的场景下，应该要求生产者把同一个 key 的消息都发到同一个分区上，这样对应的消费者就可以使用本地布隆过滤器了
#### 6. 布隆过滤器的替代品

对于一些业务，其实我这里可以把布隆过滤器换成 bit array 的结构。比如说某个业务要求判断幂等，用的就是业务的自增主键，那么他们就可以使用 bit array 这个实现来判断幂等。这里也有一个小技巧，就是假如说自增主键的起点是 N，那么在 bit array 的第一位就可以表示为 N，第二位表示为 N + 1，这样就能进一步节省内存。





# 地址

此文章为8月day18 学习笔记，内容来源于极客时间《https://time.geekbang.org/column/article/687082》