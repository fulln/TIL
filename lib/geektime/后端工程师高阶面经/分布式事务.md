---
dg-publish: true
title: 分布式事务
createTime: 2023-07-26 23:01  
---

#mysql #分布式事务

## 分布式事务
分布式事务既可以是纯粹多个数据库实例之间的分布式事务，也可以是跨越不同中间件的业务层面上的分布式事务

### 两阶段提交

1. 准备阶段，协调者让参与者执行事务，但是并不提交，协调者返回执行情况。这个阶段参与者会记录 Redo 和 Undo 信息，用于后续提交或者回滚。
2. 提交阶段，协调者根据准备阶段的情况，要求参与者提交或者回滚，参与者返回提交或者回滚的结果。准备阶段任何一个节点执行失败了，就都会回滚。全部执行成功就提交。

#### 两阶段提交协议的缺点
1. 最大缺点是在执行过程中节点都处于阻塞状态。
2. 如果协调者崩溃，整个分布式事务都无法执行。
3. 如果一个节点在第一阶段没有返回响应，那么协调者会执行回滚。所以这可能会引起不必要的回滚。

两阶段提交协议是分布式事务中最常用的协议之一，它可以有效地保证分布式事务的一致性和可靠性。


### 三阶段提交
三阶段提交协议是在两阶段提交协议的基础上进行的改进，三阶段提交协议引入了一个额外阶段来确保在执行事务之前有足够的资源，减少两阶段协议引起的事务失败的可能。

1. 第一阶段（CanCommit）：协调者问一下各个参与者能不能执行事务。参与者这时候一般是检查一下自己有没有足够的资源。
2. 第二阶段（PreCommit）：类似于两阶段提交的第一个阶段，执行事务但是不提交。
3. 第三阶段（Commit）：直接提交或者回滚。

三阶段提交协议并没有两阶段提交协议使用得那么广泛，原因有两个，一是两阶段提交协议已经足以解决大部分问题了，二是三阶段提交协议的收益和它的复杂度比起来，性价比有点低。

### XA事务

两阶段协议是一种学术理论，而 XA 则是把两阶段提交协议具像化之后的一个标准。它定义了协调者和参与者之间的接口。用专业的术语来说，就是定义了事务管理器（Transaction Manager）和资源管理器（Resource Manager）之间的接口。

### TCC
TCC 是一个追求最终一致性，而不是严格一致性的事务解决方案，它不满足 ACID 要求。TCC 是 Try-Confirm-Cancel 的缩写，它勉强也算是两阶段提交协议的一种实现。
- Try：对应于两阶段提交协议的准备阶段，执行事务但是不提交。
- Confirm：对应于两阶段提交协议第二阶段的提交步骤。
- Cancel：对应于两阶段提交协议第二阶段的回滚步骤。

### SAGA 事务

SAGA 的核心思想一句话就可以说明白，就是把业务分成一个个步骤，当某一个步骤失败的时候，就**反向补偿**前面的步骤。

SAGA 本身也是需要考虑容错的，难点就是在反向补偿的时候失败了怎么办？比如说在前面的例子里，你准备删除数据的时候失败了。那么还是没有特别好的办法，无非就是不断重试，这一部分你可以参考 TCC 中讨论的容错内容。

### AT 事务

类似于 undo log。比如说你数据库操作是一个 INSERT，那么对应的反向补偿操作就是 DELETE 了。你在回答的时候就可以结合 undo log 一起回答，顺便把话题引导到 undo log 上。

**容错基本上就是重试**，重试失败之后就有三种方案，分别是：监控 + 告警 + 人手工介入处理；读请求 + 数据修复；监控 + 告警 + 故障自动处理。


## 地址

此文章为7月day26 学习笔记，内容来源于极客时间《https://time.geekbang.org/column/article/678287》