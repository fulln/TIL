---
dg-publish: true
title: SQL优化：如何发现SQL中的问题
createTime: 2023-07-10 23:36  
---


## 高性能

尽可能为自己打造熟练掌握性能优化技巧的人设。高并发项目经验可遇不可求，但是高性能是可以勉强追求的，性能优化就是追求高性能的方法

## SQL

SQL 优化就是为了达到两个目标：

1. 减少磁盘 IO，这个又可以说是尽量避免全表扫描、尽量使用索引以及尽量使用覆盖索引。
2. 减少内存 CPU 消耗，这一部分主要是尽可能减少排序、分组、去重之类的操作。

### EXPLAIN 命令

1.  type：指的是查询到所需行的方式，

从好到坏依次是 system > const > eq_ref > ref > range > index > ALL。

- system 和 const 都可以理解为数据库只会返回一行数据，所以查询时间是固定的。
- eq_ref 和 ref 字面意思是根据索引的值来查找。
- range：索引范围扫描。
- index：索引全表扫描，也就是扫描整棵索引。
- ALL：全表扫描，发起磁盘 IO 的那种全表扫描。

2. possible_keys：候选的索引。
3. key：实际使用的索引。
4. rows：扫描的行数。数据库可能扫描了很多行之后才找到你需要的数据。
5. filtered：查找到你所需的数据占 rows 的比例。

### 索引设计

- 外键，一般都会用于关联、过滤数据，所以正常来说都会为表的外键创建索引。
- 频繁出现在 WHERE 中的列，主要是为了避免全表扫描。
- 频繁出现在 ORDER BY 的列，这是为了避免数据库在查询出来结果之后再次排序。
- 频繁出现在关联查询的关联条件中的列。不过一般我们都不建议使用关联查询，所以几乎可以忽略这个。
- 区分度很高的列。比如每一行的数据都不同的列，并且在创建组合索引的时候，区分度很高的列应该尽可能放到左边。

**修改索引或者说表定义变更的核心问题是数据库会加表锁，直到修改完成**

1. 停机变更，就是把业务停下来，然后更新表结构。如果做得更加精细一点，那么就可以说只把和这个表有关的功能下线，但不需要将整个服务或者系统下线。
2. 创建新表，这是不停机又不想业务受到影响的方案。具体来说就是创建一张新表，这张新表就是你准备用的新的表定义。然后将旧表的数据迁移过去

### 优化count
第一种方法是用估计值取代精确值，关键词是预估。

### 用 WHERE 替换 HAVING




# 地址

此文章为7月day10 学习笔记，内容来源于极客时间《https://time.geekbang.org/column/article/674168》