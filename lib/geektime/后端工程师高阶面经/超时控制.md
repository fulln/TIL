---
dg-publish: true
title: 超时控制
createTime: 2023-07-30 23:38  
---

## 超时控制

超时控制也是构建高可用系统的一环，因为它能够节省系统资源，提高资源的有效利用率。

一般我们都能给出一个差不多的回答，不过如果你能够在超时控制的话题下稍微深入一点，比如聊一聊监听超时时间、链路超时控制，那你绝对能成为所有候选人中最靓的仔。

### 和超时控制有关的内容

1. 超时控制的目标或者说好处。
2. 超时控制的形态。
3. 如何确定超时时间？这会是一个面试热点。
4. 超时之后能不能中断业务？
5. 谁来监听超时时间？

#### 超时控制目标

1. 确保客户端能在预期的时间内拿到响应
2. 及时释放资源

释放线程：在超时的情况下，客户端收到了超时响应之后就可以继续往后执行，等执行完毕，这个线程就可以被用于执行别的业务。而如果没有超时控制，那么这个线程就会被一直占有。而像 Go 这种语言，协程会被一直占有。

释放连接：连接可以是 RPC 连接，也可以是数据库连接。类似的道理，如果没有拿到响应，客户端会一直占据这个连接。

#### 超时控制形态

1. 调用超时控制，比如说你在调用下游接口的时候，为这一次调用设置一个超时时间。
2. 链路超时控制，是指整条调用链路被一个超时时间控制。比如说你的业务有一条链路是 A 调用 B，B 调用 C。如果链路超时时间是 1s，首先 A 调用 B 的超时时间是 1s，如果 B 收到请求的时候已经过去了 200ms，那么 B 调用 C 的超时时间就不能超过 800ms。

####  确定超时时间

确定超时时间是一个我们在面试中经常碰到的问题，常见的 4 种确定超时时间的方式是根据用户体验来确定、根据被调用接口的响应时间来确定、根据压测结果来确定、根据代码来确定。

1.  根据用户体验
2. 根据响应时间
	1. 大多数时候都是根据被调用接口的响应时间来确定超时时间。一般情况下，你可以选择使用 99 线或者 999 线来作为超时时间。
3. 压力测试
	1. 通过压力测试来找到被调用接口的 99 线和 999 线。
4. 根据代码计算

#### 超时中断业务
基本上会继续执行，除非服务端自己主动检测一下本次收到的请求是否已经超时了。

#### 监听超时时间

注意在公司里面收集一些跟超时控制相关的事故报告。例如因为没有设置超时时间，导致数据库连接耗尽或者线程数量飙升等事故报告。这些事故报告你可以在面试的过程中用来解释超时控制的必要性，或者用来凸显你解决事故的能力。

### 常见问题

![](https://static001.geekbang.org/resource/image/a0/d7/a082eb211df1011a25c86e28d1a160d7.jpg?wh=1920x1315)

#### 链路超时控制

> 链路超时控制和普通超时控制最大的区别是链路超时控制会作用于整条链路上的任何一环。例如在 A 调用 B，B 调用 C 的链路中，如果 A 设置了超时时间 1s，那么 A 调用 B 不能超过 1s。然后当 B 收到请求之后，如果已经过去了 200ms，那么 B 调用 C 的超时时间就不能超过 800ms。因此链路超时的关键是在链路中传递超时时间。

正常来说，在链路中传递的可以是剩余超时时间，也可以是超时时间戳

>一般超时时间传递的就两种：剩余超时时间或者超时时间戳。比如说剩余 1s，那么就用毫秒作为单位，数值是 1000。这种做法的缺陷就是服务端收到请求之后，要减去请求在网络中传输的时间。比如说 C 收到请求，剩余超时时间是 500ms，如果它知道 B 到 C 之间请求传输要花去 10ms，那么 C 应该用 500ms 减去 10 ms 作为真实的剩余超时时间。不过现实中比较难知道网络传输花了 10ms 这件事。 
>
>而传递超时时间戳，那么就会受到时钟同步影响。假如说此时此刻，A 的时钟是 00:00:00，而 B 的时钟是 00:00:01，也就是 A 的时钟比 B 的时钟慢了一秒。那么如果 A 传递的超时时间戳是 00:00:01，那么 B 一收到请求，就会认为这个请求已经超时了。 
>
>当然，正常来说时钟同步不至于出现那么大的偏差，大多数时钟偏差几乎可以忽略不计。不过在时钟回拨的场景下，还是会有问题。我之前听说不同云服务商之间的时钟同步问题比较严重，可能也需要注意。


# 地址

此文章为7月day30 学习笔记，内容来源于极客时间《https://time.geekbang.org/column/article/670877》