---
dg-publish: true
title: 保证消息有序
createTime: 2023-08-12 23:54  
---

# 保证消息有序

### 消息在分区上的组织方式

每个 topic 都可以被划分为一个或多个分区，每个分区都是一个有序、不可变的消息日志。

Kafka 使用 WAL （write-ahead-log）日志来存储消息。每个分区都有一个对应的日志文件，新的消息会被追加到文件的末尾，而已经加入日志里的消息，就不会再被修改了。

而 Kafka 本身暴露了对应的接口，也就是说你可以显式地指定消息要发送到哪个分区，也可以显式地指定消费哪个分区的数据。

### 什么是有序消息？

有序消息是指消费者消费某个 topic 消息的顺序，和生产者生产消息的顺序一模一样，它也叫做顺序消息。

###  跨 topic 的有序消息

业务会要求你在不同的 topic 之间也保证消息是有序的。比如说 msg1 先发送到了 topic_a 上， msg2 被发送到了 topic_b 上。但是在业务层面上，要求 msg1 一定要先于 msg2 消费

要引入一个协调者，这个协调者负责把消息重组为有序消息。比如说，如果 msg2 先到了，但是 msg1 还没出来，那么这个协调者要有办法让 msg2 的消费者 B 停下来，暂时不消费 msg1。而在 msg1 来了之后，唤醒消费者 A 消费 msg1，并且在消费完 msg1 之后要再唤醒消费者 B 处理 msg2。

##### 主要解决方案

1. 增加分区的问题，后面的多分区方案专门讨论了增加分区可能带来的消息失序的问题。
2. Redis 的槽和槽分配。
3. 负载均衡，你记得回答一致性哈希，然后把话题引导到利用一致性哈希来解决多分区数据分布不均匀的问题。
4. 消息积压的问题，你可以把话题引导到单分区方案和多分区方案上。



# 地址 

此文章为8月day12 学习笔记，内容来源于极客时间《https://time.geekbang.org/column/article/685914》