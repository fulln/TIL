---
dg-publish: true
title: 微服务降级功能
createTime: 2023-06-23 23:16  
---

熔断、降级、限流是三个经常合并在一起讨论的可用性保障措施

## 降级对应策略

- 如何判定服务健康，在降级中则是判定一个服务要不要降级。
- 降级之后怎么恢复，也是要考虑抖动的问题。

应该优先考虑使用降级的。然而有些服务是无法降级的，尤其是写服务。例如你从前端接收数据，然后写到数据库，这种场景是无法降级的。另外，如果你希望系统负载尽快降低，那么熔断要优于降级。

## 如何降级？

1. 跨服务降级。当资源不够的时候，可以暂停某些服务，将腾出来的资源给其他更加重要、更加核心的服务使用。我这里提到的大促暂停退款服务就是跨服务降级的例子。这种策略的要点是必须知道一个服务比另外一个服务更有业务价值，或者更加重要。
2. 本服务提供有损服务。例如各大 App 的首页都会有降级的策略。在没有触发降级的时候，App 首页是针对你个人用户画像的个性化推荐。而在触发了降级之后，则可能是使用榜单数据，或者使用一个运营提前配置好的静态页面。这种策略的要点是你得知道你的服务调用者能够接受什么程度的有损。

### 常见的做法有三个

- 整个服务停掉，例如前面提到的停掉退款服务。
- 停掉服务的部分节点，例如十个节点，停掉其中五个节点，这五个节点被挪作他用。
- 停止访问某些资源。例如日志中心压力很大的时候，发信号给某些不重要的服务，让它们停止上传日志，只在本地保存日志。

### 服务端常见降级思路

- 返回默认值，这算是最简单的一种状况。
- 禁用可观测性组件，正常来说在业务里面都充斥了各种各样的埋点。这些埋点本身其实是会带来消耗的，所以在性能达到瓶颈的时候，就可以考虑停用，或者降低采样率。
- 同步转异步，即正常情况下，服务收到请求之后会立刻处理。但是在降级的情况下，服务在收到请求之后只会返回一个代表“已接收”的响应。后续服务会异步地开启线程来处理，或者依赖于定时任务来处理。
- 简化流程，如果你处理一个请求需要很多步骤，后续如果有一些步骤不关键的话，可以考虑不执行，或者异步执行。例如在内容生产平台，一般新内容要被推送到推荐系统里面。那么在降级的情况下你可以不推，而后可以考虑异步推送过去，也可以考虑等系统恢复之后再推送过去。


**主要思路**： 读写服务降级写服务和快慢路径降级慢路径

#### 读写服务降级写服务

读服务 QPS 更高，也更加重要。虽然整体来说写服务 QPS 占比很低，但是对于数据库来说，一次写请求对性能的压力要远比一次读请求大。所以暂停了写服务之后，数据库的负载能够减轻不少。


#### 快慢路径降级慢路径

完全不考虑从数据库里取数据，那么你的性能瓶颈就完全取决于缓存或者说 Redis，那么服务能够撑住的 QPS 会非常高，如果缓存不命中的时候要去数据库取数据，那么服务的性能会衰退得非常快，即极少数缓存未命中的请求会占据大部分的系统资源。**只查缓存**


##### 快慢路径

如果一个服务可以分成快路径和慢路径两种逻辑，那么在降级之前就可以先走快路径，再走慢路径。而触发了降级之后，就只允许走快路径。在前面的例子里面，从缓存里加载数据就是快路径，从数据库里面加载数据就是慢路径。


# 地址

此文章为6月day23 学习笔记，内容来源于极客时间《https://time.geekbang.org/column/article/669254》