---
dg-publish: true
title: 未命名
createTime: 2023-06-07 00:15  
---

##  调用结果、缓存机制是怎么影响负载均衡的？

一般我们在准备调用任何服务的时候，第一个要解决的问题就是负载均衡该怎么做。

### 负载均衡算法

#### 静态负载均衡算法
轮询、加权轮询、随机和加权随机、哈希和一致性哈希

- 轮询和加权轮询

如果一个节点的权重是另外一个节点的两倍，那么最终这个节点被选中的次数也会是另外一个节点的两倍

- 平滑的加权轮询算
1. 对每一个节点，执行 currrentWeight = currrentWeight + weight。
2. 挑选最大 currrentWeight 的节点作为目标节点。
3. 将目标节点的 currrentWeight 修改为 currrentWeight= currrentWeight - sum(weight)。

那么简单理解就是，对于一个节点来说，每次被挑选之后，它的 currrentWeight 就会下降，那么下一次就不会选中它。随机与加权随机

- 随机与加权随机

- 哈希与一致性哈希
哈希算法的选取会严重影响负载均衡的效果。假如说你计算哈希值的算法不太好，就容易导致某几个节点上负载特别高，而其他节点的负载就比较低。所以要尽可能保证哈希值计算出来的结果是均匀的。

- 一致性hash

一致性哈希负载均衡引入了一个哈希环的概念，服务端节点会落在环的某些位置上。客户端根据请求参数，计算一个哈希值。这个哈希值会落在哈希环的某个位置。从这个位置出发，顺时针查找，遇到的第一个服务端节点就是目标节点。


#### 动态负载均衡算法
最少连接数、最少活跃请求数、最快响应时间等

- 最少连接数
如果一个服务端节点上的连接数越多，那么这个节点的负载就越高。因此在做负载均衡的时候就是看一下客户端和各个节点的连接数量，从中挑选出连接数数量最少的节点。

- 最少活跃数
用当前活跃请求数来代表服务端节点的负载

- 最快响应时间
用的是响应时间来代表服务端节点的负载。响应时间和前面的两个指标比起来，是一种综合性的指标，所以用响应时间来代表服务端节点负载要更加准确。

## 采集cpu负载信息
第一种思路是服务端在返回响应的时候顺便把服务端上的一些信息一并返回。这种思路需要微服务框架支持从服务端往客户端回传链路元数据

第二种思路是从观测平台上查询。例如通过查询 Prometheus 来获得各种指标数据。

## 调用结果对负载均衡的影响

权重的调整要设置好上限和下限。那么你可以揭开这个业界经常忽略的问题，关键词是上下限

调整权重的算法都要考虑安全问题，即权重的调整应该有上限和下限。比如说一般下限不能为 0，因为一个节点的权重为 0 的话，它可能永远也不会被选中，又或者和 0 的数学运算会出现问题导致负载均衡失败。上限一般不超过初始权重的几倍，比如说两倍或者三倍，防止该节点一直被连续选中。


### 应用发布

最开始有一个请求需要 user_id 为 1 的昵称小明，这个请求最开始会命中老节点。但是此时还没有查询到数据。紧接着扩容。此时又来了一个请求，那么它会被导去新节点。这一个请求会将 user_id 为 1 的昵称改为小刚。如果这时候第一个请求从老节点的缓存上读出了数据，那么它拿到的就还是老的数据。而应用发布是引起节点数量变化最常见的原因。毕竟应用发布可以看作先下线一个节点，再上线一个节点。


# 地址

此文章为6月day21 学习笔记，内容来源于极客时间《https://time.geekbang.org/column/article/668453》