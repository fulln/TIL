---
dg-publish: true
title: 限流阈值怎么算
createTime: 2023-07-03 23:17  
---

熔断、降级和限流是最常见的三种微服务架构可用性保障措施。


## 限流

限流是通过限制住流量大小来保护系统，它尤其能够解决异常突发流量打崩系统的问题

限流需要确定一个流量阈值，这个阈值该怎么算

### 静态算法
静态算法包含令牌桶、漏桶、固定窗口和滑动窗口。这些算法就是要求研发人员提前设置好阈值。在算法运行期间它是不会管服务器的真实负载的。

#### 1. 令牌桶

系统会以一个恒定的速率产生令牌，这些令牌会放到一个桶里面，每个请求只有拿到了令牌才会被执行。每当一个请求过来的时候，就需要尝试从桶里面拿一个令牌。如果拿到了令牌，那么请求就会被处理；如果没有拿到，那么这个请求就被限流了。

> 本身令牌桶是可以积攒一定数量的令牌的。比如说桶的容量是 100，也就是这里面最多积攒 100 个令牌。那么当某一时刻突然来了 100 个请求，它们都能拿到令牌。


#### 2. 漏桶

当请求以不均匀的速度到达服务器之后，限流器会以固定的速率转交给业务逻辑。

> 将令牌桶中桶的容量设想为 0，就是漏桶了。

#### 3. 固定窗口与滑动窗口

固定窗口是指在一个固定时间段，只允许执行固定数量的请求。比如说在一秒钟之内只能执行 100 个请求。

滑动窗口类似于固定窗口，也是指在一个固定时间段内，只允许执行固定数量的请求。区别就在于，滑动窗口是平滑地挪动窗口，而不像固定窗口那样突然地挪动窗口。


#### 限流对象

从单机或者集群的角度看，可以分为单机限流或者集群限流。集群限流一般需要借助 Redis 之类的中间件来记录流量和阈值。换句话说，就是你需要用 Redis 等工具来实现前面提到的限流算法。当然如果是利用网关来实现集群限流，那么可以摆脱 Redis。

#### 限流后的做法

1. 同步阻塞等待一段时间。
2. 同步转异步。
3. 调整负载均衡算法。


### 动态算法
动态算法也叫做自适应限流算法，典型的是 BBR 算法。这一类算法利用一系列指标来判定是否应该减少流量或者放大流量。动态算法和 TCP 的拥塞控制是非常接近的，只不过 TCP 控制的是报文流量，而微服务控制的是请求流量。

##### 毛刺问题。
假如一个窗口大小是一分钟 1000 个请求，你预计这 1000 个请求会均匀分散在这一分钟内。那么有没有可能第一秒钟就来了 1000 个请求？当然可能。那当下这一秒系统有没有可能崩溃？自然也是可能的。

### 阈值计算

看服务的观测数据、压测、借鉴、手动计算。

![](https://static001.geekbang.org/resource/image/8f/4d/8f957b9ae283f9bdac1ce4395e3e0f4d.jpg?wh=2708x2206)





# 地址

此文章为7月day3 学习笔记，内容来源于极客时间《https://time.geekbang.org/column/article/670039》