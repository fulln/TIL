---
dg-publish: true
title:  消息队列可以用来解决什么问题
createTime: 2023-08-10 23:11  
---

# 消息队列可以用来解决什么问题

消息队列都是业界用于构建高并发、高可用系统的利器。即便是简单的业务开发，也可以通过消息队列的解耦、异步特性来提高性能和可用性。

### 前置知识

息队列最鲜明的特性是异步、削峰、解耦。也有人说这是消息队列的使用场景、用途，并且额外加了几个，比如日志处理和消息通讯。但是实际上，日志处理和消息通讯可以看作是消息队列的具体落地案例。比如日志处理同时利用了消息队列异步、解耦和削峰的特性

消息队列还可以用来实现事件驱动架构

### 面试准备

我建议你有机会的话，在遇到一些非常复杂棘手的业务时可以考虑使用事件驱动来解决。我个人认为越复杂的业务系统，应用事件驱动就越有价值。

#### 基本思路

在简历上你就应该写上自己擅长消息队列或者说自己能够用消息队列解决问题。后续面试官在提问的时候就会考虑面消息队列这方面的内容。面试官可能会先问你用消息队列解决过什么问题，那么你回答你准备的案例就可以。

#### 秒杀场景

1. 利用消息队列把整个秒杀过程分成轻重两个部分。

在进入消息队列之前的操作都是轻量级的，一般也就是内存计算或者访问一些 Redis，所以你可以认为瓶颈基本上取决于 Redis 的性能。

而进入消息队列之后就是非常重量级的操作了，比如说要进一步验证交易的合法性，操作数据库等。

2. 订单超时取消

如果用户下单之后一直没有支付，那么这个订单就会被取消，从而释放库存。

但是消费的时候要小心并发问题，就是在 30 分钟这一个时刻，一边用户支付，一边消费者也消费超时消息，就会有并发问题。解决思路有很多，可以使用分布式锁、乐观锁，也可以使用 SELECT FOR UPDATE 锁住订单，防止并发操作。

### 为什么一定要使用消息队列？

同步调用方案相比引入消息队列有三个缺陷，分别是性能差、可扩展性差和可用性差。

1. 能差是因为你需要停下来等全部调用完成才可以返回响应。
2. 并发调用性能也比使用消息队列差。
3. 在使用消息队列的情况下，消息发送者完全不关心谁会去消费这些消息。同样地，如果有一个新的业务方要订阅这个消息，它可以自主完成。而同步调用的时候，上游必须知道下游的接口，然后要知道如何构造请求、如何解析响应，还要联调、测试、上线，整个过程都得和下游密切合作，因此效率特别低，可扩展性很差。

#### 事件驱动

整个系统不同组件之间的通信是通过事件来完成的。也就是组件 1 发送一个事件到消息队列上，然后组件 2 消费这个消息。组件 2 消费完成后再发出一个消息到消息队列。每一个事件就是一个消息。

1. 优点十分明显。

- 低耦合性：各个组件只依赖消息队列，组件之间通过消息的定义间接地耦合在一起。换句话来说，组件只需要知道消息的定义，并不需要知道发送消息的组件是哪个。
- 可扩展性：事件驱动的应用程序具有很强的扩展性，可以通过添加新的事件处理程序、组件等来实现系统的扩展和升级。
- 高可用：可以充分利用消息队列的可靠性、可重复消费等特性，来保证消息发送、消费高可用，从而保证整个系统的高可用。

事件驱动适合用来解决一些复杂、步骤繁多、流程冗长的业务问题。

当某一个步骤完成之后，就会发出一个或者多个事件，驱动事务中的后续步骤。包括回滚也是这样，比如说发出一个代表某一个步骤执行失败的事件，对应的消费者就会去执行反向补偿步骤。

**使用事件驱动的优点是低耦合、高扩展性、异步、高可用。** 不过在实时性上要比同步调用差一点。我用一个最简单的例子给你解释清楚它的运作。比如说你有一个分布式事务，就是要求先更新 DB，再更新缓存。那么在缓存更新失败的场景下，过程看起来就像图里展示的这样。

**基于事件驱动的 SAGA 分布式事务方案**


# 地址

此文章为8月day10 学习笔记，内容来源于极客时间《https://time.geekbang.org/column/article/684182》