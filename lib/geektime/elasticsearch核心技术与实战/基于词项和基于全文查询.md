---
dg-publish: true
title: 基于词项和基于全文查询
createTime: 2023-05-25 21:44  
---

## 基于Term的查询

- Term是表达语意的最小单位，搜索和利用统计语言模型进行自然语言处理都需要Term
- 特点
	- Term level Query ： Term Query/ Range Query/ Exists Query / Prefix Query /Wildcard Query
	- Es中，Term 查询，对输入不分词，会将输入作为一个整体，在倒排索引中查询准确的词项，并且使用相关度算分公式为每个包含该词项的文档进行相关度算分
	- 可以通过Constant Score 将查询转换成一个Filtering ，避免算分，并利用缓存，提高性能

```
POST /products/_bulk
{ "index": { "_id": 1 }}
{ "productID" : "XHDK-A-1293-#fJ3","desc":"iPhone" }
{ "index": { "_id": 2 }}
{ "productID" : "KDKE-B-9947-#kL5","desc":"iPad" }
{ "index": { "_id": 3 }}
{ "productID" : "JODL-X-1937-#pV7","desc":"MBP" }

GET /products
# 直接查询是查不到的
POST /products/_search
{
  "query": {
    "term": {
      "desc": {
        //"value": "iPhone"
        "value":"iphone"
      }
    }
  }
}

# 查询keyword
POST /products/_search
{
  "query": {
    "term": {
      "desc.keyword": {
        //"value": "iPhone"
        //"value":"iphone"
      }
    }
  }
}
```

### 复合查询 -Constant Score 转 Filter

- 将Query 转Filter ，忽略TF-IDF 计算，避免相关性算分开销
- Filter 有效利用缓存

```
POST /products/_search
{
  "explain": true,
  "query": {
    "constant_score": {
      "filter": {
        "term": {
          "productID.keyword": "XHDK-A-1293-#fJ3"
        }
      }

    }
  }
}
```

## 基于全文本的查询

- 基于全文本查询
	- Match Query / Match Phrase Query / Query String Query
- 特点
	- 索引和搜索时都会进行分词，查询字符串先传递到一个合适的分词器，然后生成一个供查询的词项列表
	- 查询时候，先回对输入的查询进行分词，然后每个词项逐个进行底层查询，最终将结果进行合并，并每个文档生成一个算分。

![[Pasted image 20230525221020.png]]

## 结构化搜索

### 结构化数据

- 结构化搜索是对结构化数据的搜索
	- 日期，bool，和数字都是结构化的
- 文本也是结构化的

### Es的结构化搜索

- 布尔，时间，数字有精确的格式，可以对格式进行逻辑操作， 包括比较数字或时间的范围，或判定2个值大小
- 结构化文本可以做精确匹配或者部分匹配
	- Term 查询/Prefix 前缀查询
- 结构化结果只有是 或 否 2个值
	- 根据场景需要，可以决定结构化搜索是否需要打分



```

DELETE products
POST /products/_bulk
{ "index": { "_id": 1 }}
{ "price" : 10,"avaliable":true,"date":"2018-01-01", "productID" : "XHDK-A-1293-#fJ3" }
{ "index": { "_id": 2 }}
{ "price" : 20,"avaliable":true,"date":"2019-01-01", "productID" : "KDKE-B-9947-#kL5" }
{ "index": { "_id": 3 }}
{ "price" : 30,"avaliable":true, "productID" : "JODL-X-1937-#pV7" }
{ "index": { "_id": 4 }}
{ "price" : 30,"avaliable":false, "productID" : "QQPX-R-3956-#aD8" }


#对布尔值 match 查询，有算分
POST products/_search
{
  "profile": "true",
  "explain": true,
  "query": {
    "term": {
      "avaliable": true
    }
  }
}

#对布尔值，通过constant score 转成 filtering，没有算分
POST products/_search
{
  "profile": "true",
  "explain": true,
  "query": {
    "constant_score": {
      "filter": {
        "term": {
          "avaliable": true
        }
      }
    }
  }
}
```

#### 日期range

| 字符 | 含义 |
| ---- | ---- |
| y    | 年   |
| M    | 月   |
| w    | 周   |
| d    | 天   |
| H/h  | 小时 |
| m    | 分钟 |
| s    | 秒     |

```

# 日期 range
POST products/_search
{
    "query" : {
        "constant_score" : {
            "filter" : {
                "range" : {
                    "date" : {
                      "gte" : "now-1y"
                    }
                }
            }
        }
    }
}
```

#### 处理多值字段

```
#处理多值字段，term 查询是包含，而不是等于
POST movies/_search
{
  "query": {
    "constant_score": {
      "filter": {
        "term": {
          "genre.keyword": "Comedy"
        }
      }
    }
  }
}
```

term在多值查询逻辑是包含而不是相等。
- 可以通过增加count字段来区分