---
dg-publish: true
title: 作用范围及排序
createTime: 2023-06-15 23:08  
---

## Aggs.sort


- 指定order，按照count 和key进行排序
	- 默认情况，按照count降序排序
	- 指定size，返回响应的桶

```http
  

#排序 order

#count and key

POST employees/_search

{

  "size": 0,

  "query": {

    "range": {

      "age": {

        "gte": 20

      }

    }

  },

  "aggs": {

    "jobs": {

      "terms": {

        "field":"job.keyword",

        "order":[

          {"_count":"asc"},

          {"_key":"desc"}

          ]

      }

    }

  }

}
```

```http
#排序 order

#count and key

POST employees/_search

{

  "size": 0,

  "aggs": {

    "jobs": {

      "terms": {

        "field":"job.keyword",

        "order":[  {

            "stats_salary.min":"desc"

          }]

      },

    "aggs": {

      "stats_salary": {

        "stats": {

          "field":"salary"

        }

      }

    }

    }

  }

}

```


## 聚合分析的原理及精准度问题

![[Pasted image 20230615233201.png]]

### min聚合分析的执行流程

1. 发起min 聚合请求
2. Coordinating Node

### Term Aggrs 的返回值

在Term Aggregation 的返回中有2个特殊的值
-  doc_count_error_upper_bound 被遗漏的term分桶，有可能是最大值
- sum_other_doc_count；除了返回结果的terms外，其他terms的文档总数

1. 发出term聚合分析，size = 3
2.  在3个子分片取得最大文档数3
3. 在Coordinating Node上汇总，
4. 返回结果（不一定准）

### 如何解决

- 提升shard_size 的参数
	- Terms聚合分析不准确的原因，数据分散在多分片上，Coordnating 无法获取数据全貌
		- 数据不大设置Primary Shard = 1,实现准确性
		- 在分布式数据上，设置shard_size 参数，提高精确度
			- 每次从Shard 上额外多获取数据

# 地址

此文章为6月day15 学习笔记，内容来源于极客时间《https://time.geekbang.org/course/detail/100030501-118149》