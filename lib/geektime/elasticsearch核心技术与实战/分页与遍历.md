---
dg-publish: true
title: 分页与遍历
createTime: 2023-06-09 22:12  
---

## from /  size

from: 开始位置
size： 期望获取文档的总数


## 分布式系统中深度分页的问题

- es天生就是分布式，数据分别保存在多个分片，多台机器，es天生需要满足排序的需求
- 当一个查询： From = 990 ，Size = 10
	- 在每个分片上先都获取100个文档，然后通过Coordinating Node聚合结果，最后在排序选取前1000个文档
	- 页数越深，占用内存越多，为了避免深度分页，es默认限制到10000个文档

## SearchAfter 避免深度翻页的问题

实时获取下一页文档信息
	- 不支持制定页数
	- 只能往下翻
- 第一步指定sort，并保证值唯一
- 使用上一次，最后一个文档的sort值进行查询

```http
POST users/_search
{
    "size": 1,
    "query": {
        "match_all": {}
    },
    "sort": [
        {"age": "desc"} ,
        {"_id": "asc"}    
    ]
}
```

search after

```http
POST users/_search

{

    "size": 1,

    "query": {

        "match_all": {}

    },

    "search_after":

        [

          10,

          "ZQ0vYGsBrR8X3IP75QqX"],

    "sort": [

        {"age": "desc"} ,

        {"_id": "asc"}    

    ]

}
```

## Scoll API

- 创建快照，有新的数据写入后，无法被查到
	- 每次先创建快照，并设置时间
- 每次查询都要输入上次的id

```http
POST /users/_search?scroll=5m
{
    "size": 1,
    "query": {
        "match_all" : {
        }
    }
}
  
POST /_search/scroll

{

    "scroll" : "1m",

    "scroll_id" : "DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAAAWAWbWdoQXR2d3ZUd2kzSThwVTh4bVE0QQ=="

}
```

## 不同的搜索类型与场景

- Scoll 
	- 需要全部文档，如导出
- Pagination
	- from 和size
	- 如果深度分页，search after

# 地址

此文章为6月day9 学习笔记，内容来源于极客时间《https://time.geekbang.org/course/detail/100030501-114568》