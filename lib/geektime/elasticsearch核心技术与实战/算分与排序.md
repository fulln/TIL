---
dg-publish: true
title: 算分与排序
createTime: 2023-06-01 21:14  
---

### 算分

- es默认以文档相关度进行排序
- 可以指定一个或者多个字段进行排序
- 使用相关度算分（score） 排序，不能满足某些特定条件
	- 无法针对相关度，对排序实现更多的控制

#### Function Score Query
- 可以在查询结束后，对每个匹配的文档进行一系列的重新算分，根据新生成的分数排序
- 给了几个默认的算分的函数
	- weight 权重
	- Field value Factor ，使用该值修改_SCORE 
	- Random score 为每一个用户使用一个不同的随机算分结果
	- 衰减函数，以某个字段的值为标准，
	- scrpit Score，自定义脚本

##### 提升权重


```
DELETE blogs
PUT /blogs/_doc/1
{
  "title":   "About popularity",
  "content": "In this post we will talk about...",
  "votes":   0
}

PUT /blogs/_doc/2
{
  "title":   "About popularity",
  "content": "In this post we will talk about...",
  "votes":   100
}

PUT /blogs/_doc/3
{
  "title":   "About popularity",
  "content": "In this post we will talk about...",
  "votes":   1000000
}


POST /blogs/_search
{
  "query": {
    "function_score": {
      "query": {
        "multi_match": {
          "query":    "popularity",
          "fields": [ "title", "content" ]
        }
      },
      "field_value_factor": {
        "field": "votes"
      }
    }
  }
}
```

##### 使用Modifier 平滑曲线

![[Pasted image 20230601213249.png]]

```
POST /blogs/_search
{ 
  "query": {
    "function_score": {
      "query": {
        "multi_match": {
          "query":    "popularity",
          "fields": [ "title", "content" ]
        }
      },
      "field_value_factor": {
        "field": "votes",
        "modifier": "log1p"
      }
    }
  }
}
```

##### 使用Facotr
```

POST /blogs/_search
{
  "query": {
    "function_score": {
      "query": {
        "multi_match": {
          "query":    "popularity",
          "fields": [ "title", "content" ]
        }
      },
      "field_value_factor": {
        "field": "votes",
        "modifier": "log1p" ,
        "factor": 0.1
      }
    }
  }
}
```

### Boost Mode 和Max Boost

- Boost Mode
	- Multiply: 算分和函数相乘
	- Sum: 算分和函数之和
	- Min/Max: 算分和函数最小值
	- Replace: 使用函数分
- Max Boost 将算分控制在一个最大值


### 一致性随机函数

- 让每个用户看到不同随机排名，但是同一个用户访问结果相关顺序一致


```
POST /blogs/_search
{
  "query": {
    "function_score": {
      "random_score": {
      // 通过seed 控制一致
        "seed": 911119
      }
    }
  }
}
```


# 地址

此文章为6月day1 学习笔记，内容来源于极客时间《https://time.geekbang.org/course/detail/100030501-111009》