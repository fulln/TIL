---
dg-publish: true
title: 分片和故障转移
createTime: 2023-06-06 22:48  
---

## Replica Shard - 提高数据可用性

- 数据可用性
	- 通过引入副本分片，提高数据可用性，一旦主分片丢失，副本分片可以Promote 成主分片，副本分片可以动态调整，每个节点上都有完备的数据，
- 提升系统的读取性能
	- 副本分片由主分片同步，通过支持增加Replica 个数，一定程度可以提高读取的吞吐量

## 分片设定

-  主分片数过小：
	- 如果该索引增长很快，集群无法通过增加节点来对索引进行数据扩展
- 主分片数据设置过大：
	- 单个shard 容量小，引发一个节点上由过多分片，影响性能
- 副本分片数设置过多，降低写入性能

## 故障转移

1. 集群重新选举Master节点
2. Node3上的R0 提升为P0，集群变黄
3. R0和R1分配完成，变绿色

# 文档分布式存储

- 文档到分片的映射算法
	- 确保分片均匀分布在所有分片上，充分利用硬件资源，避免部分机器空闲
	- 潜在算法：
		- 随机，查询文档1，分片数多，需要查询多次才能查到文档1
		- 维护文档分片关系，文档数量大，维护成本高
		- 实时计算，自动计算需要哪个分片上获取文档

### 文档到分片的路由算法

- shard = hash(\_routing)%number_of_primary_shards
	- hash算法保证文档均匀分散到分片上
	- 默认routing为文档id
	- 可以自行制定routing数值
	- 设置Index Setting后，Primary数，不能随意修改的根本原因

### 文档更新流程
	1. index 用户发出更新文档请求到路由分片
	2. hash 通过hash算出路由到哪个分片
	3. route 将请求发送到分片上
	4. delete/index es文档更新是先删除在创建
	5. 成功之后返回标识到coordinate node
	6. response 给用户

# 地址

此文章为6月day6 学习笔记，内容来源于极客时间《https://time.geekbang.org/course/detail/100030501-112075》
