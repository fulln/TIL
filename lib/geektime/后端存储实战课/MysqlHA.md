---
dg-publish: true
---

#lib #geektime #后端存储实战课 

# 07｜MySQL HA：如何将“删库跑路”的损失降到最低？

### 如何更安全地做数据备份和恢复？

最简单的备份方式就是全量备份。备份的时候，把所有的数据复制一份，存放到文件中，恢复的时候再把文件中的数据复制回去，这样可以保证恢复之后数据库中的数据和备份时是完全一样的。在 MySQL 中，你可以使用mysqldump命令来执行全量备份。

MySQL 自带了 Binlog，就是一种实时的增量备份。Binlog 里面记录的就是 MySQL 数据的变更的操作日志，开启 Binlog 之后，我们对 MySQL 中的每次更新数据操作，都会被记录到 Binlog 中。

#### 备份需要注意的点

1. “不要把所有的鸡蛋放在同一个篮子中”，无论是全量备份还是 Binlog，都不要和数据库存放在同一个服务器上

2. 在回放 Binlog 的时候，指定的起始时间可以比全量备份的时间稍微提前一点儿，确保全量备份之后的所有操作都在恢复的 Binlog 范围内，这样可以保证恢复的数据的完整性。

### 配置 MySQL HA 实现高可用

#### 主备同步时序

1. 在磁盘写入主库binlog
2. 主库更新存储引擎中的数据
3. 客户端返回成功
4. 主库把数据同步到备库
5. 从库回放binlog， 更新存储引擎中的数据


# 08 | 一个几乎每个系统必踩的坑儿：访问数据库超时

### 事故排查过程

#### 编写sql的时候仔细评估

第一，sql编写与评估

1. 你的 SQL 涉及到的表，它的数据规模是多少？
2. 你的 SQL 可能会遍历的数据量是多少？
3. 尽量地避免写出慢 SQL。

第二，能不能利用缓存减少数据库查询次数？在使用缓存的时候，还需要特别注意的就是缓存命中率，要尽量避免请求命中不了缓存，穿透到数据库上。

### 架构减轻故障对系统的影响

1. 上线一个定时监控和杀掉慢 SQL 的脚本。这个脚本每分钟执行一次，检测上一分钟内，有没有执行时间超过一分钟（这个阈值可以根据实际情况调整）的慢 SQL，如果发现，直接杀掉这个会话。

2. 做一个简单的静态页面的首页作为降级方案

# 09 | 怎么能避免写出慢SQL？

### 定量认识 MySQL

影响 MySQL 处理能力的因素很多，比如：服务器的配置、数据库中的数据量大小、MySQL 的一些参数配置、数据库的繁忙程度等等。但是，通常情况下，这些因素对于 MySQL 性能和处理能力影响范围，大概在几倍的性能差距。所以，我们不需要精确的性能数据，只要掌握一个大致的量级，就足够指导我们的开发工作了。


1. 一台 MySQL 数据库，大致处理能力的极限是，每秒一万条左右的简单 SQL，这里的“简单 SQL”，指的是类似于主键查询这种不需要遍历很多条记录的 SQL。根据服务器的配置高低，可能低端的服务器只能达到每秒几千条，高端的服务器可以达到每秒钟几万条，所以这里给出的**一万 TPS** 是中位数的经验值。考虑到正常的系统不可能只有简单 SQL，所以实际的 TPS 还要打很多折扣。

	一般一台 MySQL 服务器，平均每秒钟执行的 SQL 数量在几百左右，就已经是非常繁忙了，即使看起来 CPU 利用率和磁盘繁忙程度没那么高，你也需要考虑给数据库“减负”了。

2. 到底多慢的 SQL 才算慢 SQL。这里面这个“慢”，衡量的单位本来是执行时长，但是时长这个东西，我们在编写 SQL 的时候并不好去衡量。那我们可以用执行 SQL 查询时，需要遍历的数据行数替代时间作为衡量标准，因为查询的执行时长基本上是和遍历的数据行数正相关的。
	1. 如果遍历行数在百万以内的，只要不是每秒钟都要执行几十上百次的频繁查询，可以认为是安全的
	2. 遍历数据行数在几百万的，查询时间最少也要几秒钟，你就要仔细考虑有没有优化的办法
	3. 遍历行数达到千万量级和以上的，我只能告诉你，这种查询就不应该出现在你的系统中（在线系统）

3. 遍历行数在千万左右，是 MySQL 查询的一个坎儿。MySQL 中单个表数据量，也要尽量控制在一千万条以下，最多不要超过二三千万这个量级。原因也很好理解，对一个千万级别的表执行查询，加上几个 WHERE 条件过滤一下，符合条件的数据最多可能在几十万或者百万量级，这还可以接受。但如果再和其他的表做一个联合查询，遍历的数据量很可能就超过千万级别了。所以，**每个表的数据量最好小于千万级别**


### 使用索引避免全表扫描

对于更新频繁并且对更新性能要求较高的表，可以尽量少建索引。而对于查询较多更新较少的表，可以根据查询的业务逻辑，适当多建一些索引。

### 分析 SQL 执行计划





# 地址

此文章为3月day26 学习笔记，内容来源于极客时间《[09 | 怎么能避免写出慢SQL？ (geekbang.org)](https://time.geekbang.org/column/article/211555)》，《[08 | 一个几乎每个系统必踩的坑儿：访问数据库超时 (geekbang.org)](https://time.geekbang.org/column/article/211008)》,《[07｜MySQL HA：如何将“删库跑路”的损失降到最低？ (geekbang.org)](https://time.geekbang.org/column/article/210210)》

