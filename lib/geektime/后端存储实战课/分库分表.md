---
dg-publish: true
---
#java #mysql #极客时间 

# 15 | MySQL存储海量数据的最后一招：分库分表

> [!info] 解决海量数据的问题，必须要用到分布式的存储集群，因为 MySQL 本质上是一个单机数据库，所以很多场景下不是太适合存 TB 级别以上的数据。

绝大部分的电商大厂，它的在线交易这部分的业务，比如说，订单、支付相关的系统，还是舍弃不了 MySQL，原因是，**只有 MySQL 这类关系型数据库，才能提供金融级的事务保证**

### 如何规划分库分表？

分库还是分表？分库呢，就是把数据拆分到不同的 MySQL 库中去，分表就是把数据拆分到同一个库的多张表里面。

在考虑到底是分库还是分表之前，我们需要先明确一个原则，**那就是能不拆就不拆，能少拆不多拆**。原因也很简单，你把数据拆分得越散，开发和维护起来就越麻烦，系统出问题的概率就越大。

#### 分库分表解决2个问题

1. 数据量大查询慢的问题
	- 解决查询慢，只要减少每次查询的数据总量就可以了，也就是说，分表就可以解决问题。
2. 为了应对高并发的问题
	- 应对高并发的思想我们之前也说过，一个数据库实例撑不住，就把并发请求分散到多个实例中去，所以，解决高并发的问题是需要分库的。

**简单地说，数据量大，就分表；并发高，就分库。**

> [!warnING] **越简单的设计可靠性越高**

#### 如何解决shardingKey

-  选择这个 Sharding Key 最重要的参考因素是，我们的业务是如何访问数据的

查询的话选择将订单数据同步到其他存储系统中去。在其他的存储系统里面解决。

> [!tip] 
一旦做了分库分表，就会极大地限制数据库的查询能力，之前很简单的查询，分库分表之后，可能就没法实现了。分库分表一定是，数据量和并发大到所有招数都不好使了，我们才拿出来的最后一招

### 如何选择分片算法

^09838f

#### 范围查询

1. 热点问题
	- 我们希望并发请求和数据能均匀地分布到每一个分片上，尽量避免出现热点
	- 基于范围来分片容易产生热点问题，不适合作为订单的分片方法。范围分片特别适合那种数据量非常大，但并发访问量不大的 ToB 系统。
2. 查询更友好，适合并发量不大的场景

#### hash分片

一般来说，订单表都采用更均匀的哈希分片算法。比如说，我们要分 24 个分片，选定了 Sharding Key 是用户 ID，那我们决定某个用户的订单应该落到那个分片上的算法是，拿用户 ID 除以 24，得到的余数就是分片号。

#### 查表法

查表法其实就是没有分片算法，决定某个 Sharding Key 落在哪个分片上，全靠人为来分配，分配的结果记录在一张表里面。每次执行查询的时候，先去表里查一下要找的数据在哪个分片中。

> [!tip] 
分片映射表本身的数据不能太多，否则这个表反而成为热点和性能瓶颈了。查表法相对其他两种分片算法来说，缺点是需要二次查询，实现起来更复杂，性能上也稍微慢一些。但是，分片映射表可以通过缓存来加速查询，实际性能并不会慢很多。


# 地址

此文章为3月day30 学习笔记，内容来源于[极客时间](https://time.geekbang.org/column/article/217568)


