#java #mysql #DB #极客时间 

# 20 | 如何在不停机的情况下，安全地更换数据库？

### 几种常见的需要更换数据库的情况

1. 对 MySQL 做了分库分表之后，需要从原来的单实例数据库迁移到新的数据库集群上。
2. 系统从传统部署方式向云上迁移的时候，也需要从自建的数据库迁移到云数据库上。
3. 一些在线分析类的系统，MySQL 性能不够用的时候，就需要更换成一些专门的分析类数据库，比如说 HBase。

### 如何实现不停机更换数据库？

**我们在设计迁移方案的时候，一定要做到，每一步都是可逆的。要保证，每执行一个步骤后，一旦出现问题，能快速地回滚到上一个步骤。**

- 不仅要往新库复制数据，还要保证新旧两个库的数据是实时同步的

### 同步方式
1. 可以使用 Binlog 实时同步数据
2. 复制状态机理论来实现

### 改造业务逻辑

1. 支持双写新旧两个库，并且预留热切换开关，能通过开关控制三种写状态：只写旧库、只写新库和同步双写。
2. 支持读新旧两个库，同样预留热切换开关，控制读旧库还是新库。

**双写的业务逻辑，一定是先写旧库，再写新库，并且以写旧库的结果为准。**


切换到双写之后，新库与旧库的数据可能会存在不一致的情况，原因有两个：一是停止同步程序和开启双写，这两个过程很难做到无缝衔接，二是双写的策略也不保证新旧库强一致，这时候我们需要上线一个对比和补偿的程序，这个程序对比旧库最近的数据变更，然后检查新库中的数据是否一致，如果不一致，还要进行补偿。

### 实现对比和补偿程序

有一点需要说明的是，上面这些方法，如果严格推敲，都不是百分之百严谨的，都不能保证在任何情况下，经过对比和补偿后，新库的数据和旧库就是完全一样的。但是，在大多数情况下，这些实践方法还是可以有效地收敛新旧两个库的数据差异，你可以酌情采用。

### 切换完整流程

1. 上线同步程序，从旧库中复制数据到新库中，并实时保持同步；
2. 上线双写订单服务，只读写旧库；
3. 开启双写，同时停止同步程序；
4. 开启对比和补偿程序，确保新旧数据库数据完全一样；
5. 逐步切量读请求到新库上；
6. 下线对比补偿程序，关闭双写，读写都切换到新库上；
7. 下线旧库和订单服务的双写功能。