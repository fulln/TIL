
### mysql的复制

mysql 支持2种复制,都是写入binlog

1. 基于行的复制
2. 基于语句的复制

#### 需要高可用的原因

- 宕机原因
1. 运行环境问题,操作系统,硬件软件 ,常见于磁盘耗尽
2. 性能问题,糟糕sql ,索引设计
3. 复制,主备数据不一致
4. 数据丢失,缺少可备份数据

#### 复制常见用途

1. 数据分布,在不同的地理位置分布数据备份
2. 负载均衡,通过mysql复制将读请求分布在不同服务器
3. 高可用与故障切换,避免mysql单点失败,显著缩短宕机时间

#### 复制执行步骤

1. 主库把数据更改记录到binlog,按照事物提交顺序来记录,记录完成之后就可以提交事务了.
2. 备库把主库日志复制到自己的relaylog,备库启动一个io线程与主库连接,然后在主库启动一个io转储线程,读取binlog,这线程追上了主库,则等待休眠,直到新事务进来唤醒
3. 备库读取relaylog的事件,并重放到备库数据上

该复制架构实现了获取事务和重放事务的解耦,允许都异步执行

#### 新服务器的主从复制

新库同步主库数据

1. 从主库复制数据
2. 从另外一从库复制数据
3. 使用最近一次备份来启动从库

保持同步的3个条件

1. 某个时间点的数据快照
2. 主当前的binlog文件和 数据快照在当前binlog文件的数据偏移量
3. 从快照时间到现在的binlog文件

备库也可以开启同步,设置参数为log_slave_update, 就可以从备库里面复制

#### 推荐的复制配置

1. sync_binlog=1,开启这个配置后binlog每次commit前刷到磁盘.
2. 推荐binlog与relaylog 都默认指定详细地址,以免版本和服务器名变化导致加载问题
3. skip_slave_start 防止备库崩溃后自动重启复制,导致出现更严重问题
4. sync_master_info = 1,sync_relay_log = 1,sync_relay_log_info = 1

可能产生的问题:

- 基于语句复制
1. 基于时间或者用户等元素导致结果不一致
2. 更新必须串行,导致需要更多锁

- 基于行的复制
1. 复杂逻辑下sql 执行的更加慢
2. 影响行数多的sql,导致大量插入

使用参数binlog_format(row/statement/mixed)来控制使用哪种具体模式, 默认使用基于语句的复制,当无法正确复制时,就切换到行的复制.复制无法扩展写操作, 扩展写只能让写效率更低.

InnoDB加锁读会导致锁竞争,mysql需要加锁保证执行结果在主备上是一致的,

#### 半同步复制

帮忙备库拥有主库数据的拷贝,减少丢失数据的危险,当提交事务的时候,在客户端接收到resp之前,必须保证binlog至少已经传输到了1台备库上,

1. 主库将事务提交到磁盘上之后会增加一部分延迟,是影响的返回到客户端的延迟,并不影响主库的事务提交
2. 备库是接受到事务之后进行的返回,不是等事务执行完之后进行的返回
3. 如果备库一直没有回应,会超时并转化成为异步复制模式