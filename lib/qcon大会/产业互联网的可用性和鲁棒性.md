---
dg-publish: true
title: 产业互联网的可用性和鲁棒性
createTime: 2023-05-26 13:59  
---

> PDF: [[01.产业互联网时代的单笔高可用和鲁棒性-郭凤钊（已晨）.pdf]]


### 单笔高可用

#### 高可用

1. 消费互联网的系统高可用
	1. 通常用几个9来表述
2. 增加MTBF 平均故障间隔
	通过增加冗余，提升整体可靠性和容错性
3. 降低MTTR 平均恢复时长
	下面的是阿里安全生产的1-5-10的图示
![[Pasted image 20230529215558.png]]
> [!abstract] 产业互联网的高可用要求更高
> 单笔订单或单笔请求都要高可用


| 高可用策略      | 消费互联网的高可用策略                                                               | 产业互联网的高可用策略                                                                 | 「单笔高可用」技术能力支撑 |
| --------------- | ------------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------- | -------------------------- |
| 日志Logging     | 事件，用户身份（cookie、sessionId、userId）系统表现、错误码                          | 事件、用户身份、系统表现、错误码，业务单号，单据状态                                   | 高可用日志框架             |
| 链路追踪Tracing | 调用链路（一次系统RPC调用，traceId唯一）                                             | 调用链路（一次完整RPC调用，traceId唯一）业务全链路（多次RPC调用，业务单号唯一）        | 单笔异常的全链路排查能力   |
| 监控Metrics     | 指标监控（流量、错误、延时、饱和度等）                                               | 指标监控（流量、错误、延时、饱和度等），卡单监控，上下游数据一致性监控                 | 单笔核对类监控能力         |
| 演练/故障注入   | 系统服务，容器、宿主机，网络、机房等基础设施                                         | 系统服务，容器、宿主机、网络、机房等基础设施，卡单异常注入，单据数据篡改               | 单笔异常的无损注入能力     |
| 应急防御        | 限流（对上游），降级（弱依赖、非重要功能），重启，切流（按地域、运营商），回滚，扩容 | 限流（对上游），降级（非重要功能），重启，切流（按照业务ID），回滚、扩容，控速、hold单 | 鲁棒性架构                 |
| 变更灰度        | 蓝绿发布、金丝雀发布、灰度发布                                                       | 蓝绿发布、金丝雀发布、灰度发布                                                         |                            |
| 压测                |构造高并发| 构造高并发（蓄洪）|                            |


### 可用性工具能力建设

1. 统一的结构化日志
2. 单笔全链路查询排查
3. 主动识别单笔异常
4. 真实，无损的单笔异常注入
5. 故障主动防御


##### 统一日志

> [!info] 正常日志格式
> 
时间戳->业务场景->是否成功->耗时->错误码->错误信息->请求id->调用序号
timestamp->eventCode->success->rt->errorCode->errorMsg->traceId->rpcId

> [!ERROR] 异常日志格式
 时间戳->异常类->异常方法->异常行号->错误码->错误信息->请求id->堆栈
timestamp->clazz->method->lineNumber->errorCode->errorMsg->traceId-> exceptionStack

1. 场景入口日志
	- entrance.log
2. 出入参日志
	- biz.log
3. 下游调用日志
	- event.log
4. 异常日志
	- error.log

##### 链路排查平台

排查中会遇到的问题:
1. 每次都是全链路排查
2. 没有权限跨域查询数据
3. 单一的业务域无法串联全局
4. 数据存储异构，全链路的存储介质都不同

**通过结构化日志+打通可观测体系（自建观测平台）**

##### 上下游数据一致性

> binlog同步 -> 落库hbase -> 数据校验.

单日百亿条数据，验证上下游的数据一致性。

##### 单笔异常注入
使用混沌工程常常需要控制异常注入和爆炸半径

**产业互联网中混沌工程常见挑战**：

1. 异常的注入不够真实
2. 真实异常不敢注入

当前使用的方式：
1. 数据旁路篡改，看一致性校验监控中是否得以发现
2. 构建测试流量

### 鲁棒性架构策略
要面向失败的架构设计

#### 分析问题

1. 代码中缺乏【保护式编程】
	1. 非法数据校验
2. 系统中缺乏【面向异常的设计】
	1. 下游异常的处理流程
	2. 异常直接抛给用户
	3. 幂等机制
	4. 消息乱序导致的不合法
3. 架构中缺乏【数据一致性保证】
	1. OLAP 和OLTP的数据不一致
	2. 缓存与数据库
	3. 上下游数据不一致
	4. 消息消费失败
	5. 并发场景问题
	6. ...
4. 流程中缺乏【异常闭关机制】
	1. 任务失败与后续补偿

#### 解决问题

- 定目标，挑战型目标牵引项目
- 做度量，以特殊关键词作为观测指标
- 建能力，分布式锁，重试等组件
- 重运营

##### 重试平台

![[Pasted image 20230530004259.png]]


### 产品建设实践

#### 以『业务场景』为视角的观测产品
产品建设从具体业务出发，快速汇聚数据，减少用户完成「任务」的步骤，对已有平台做解构与重构

#### 面向『治理流程』的异常日志治理产品
低成本是产品的成败关键
1. 低成本接入：
	• 不影响已有日志打印
	• 不需要修改已有监控
2. 低成本使用：
	• 一键治理，不发代码
	• 多维度数据辅助决策
	• 集成到变更风控流程中
3. 低成本支出：
	• 低于￥10/月（采样存储）

### 总结

1. 所有的理念和工具都有其适用场景，不用迷信
2. 对自身业务场景的理解和抽象，是做好高可用的前提
3. 高可用是复杂问题，解决复杂问题，需要体系化拆解
4. 尽可能在上游（架构）解决问题，成本更低，效果更好


