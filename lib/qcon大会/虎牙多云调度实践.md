---
dg-publish: true
title: 虎牙多云调度实践
createTime: 2023-05-28 00:34  
---

PDF: [[04多云流量调度和接入在虎牙的落地实践-周健.pdf]]

### 云接入现状

1. 市面流量接入产品多种多样
	1. 安全
	2. 负载均衡
	3. 访问加速
	4. DNS
	5. ...

2. 相同类型的产品在多云之间有很多差异
	1. 监控粒度，指标差异
	2. 管理api
	3. 计费的模式

3. 接入成本高企不下
	- 流量成本占比大，容易发生变化，典型如s赛期间的流量激增
	- 收费差异，不同的产品的收费差巨大
	- 流量大头，厂商的监控粒度普遍不够精细

4. 网络故障常见
	云联网产品，主要是出现路由下发异常或者是硬件升级等异常，这种一般耗时短，但是波及范围广，而且频率能达到一年多次

### 多云接入落地标准化:

从下面几点去围绕打造流量调度平台

1. 基础接入标准
	1. 基础api功能一致性，能平台包装产品，核心配置需要同步到多个平台，定期进行数据校验
	2. 收集云监控指标，并基于监控提供一致的告警内容
	3. 打造可用性，能多区域接入，需要同时接入在线流量，随时进行切换
2. 核心产品标准
	1. DNS
		1. 就近解析能力
		2. 多个k8s集群联动。打通微服务
		3. 秒级解析生效
		4. 基于标签进行流量调度
	2. 7层负载均衡
		1. 转发流量快速屏蔽
		2. 证书安全
		3. 域名和路径的监控指标
		4. 扩展机制
3. 打造权威DNS
	1. 自建+云解析同时使用
		1. 自建机房作为DNS后台，写入master，同步到各个云服务
	2. 用云上弹性资源部署slave节点
		1. 用以做到扩容缩容
	3. 解析服务异常自动切换
![[Pasted image 20230530221303.png]]

4. 打造智能DNS
	- nameServer打通微服务,k8s,dns信息,提供统一dns解析能力
		- 配置存放nacos，同步对应service和ip等信息到nameServer
		- dns管理后台同步对应dns信息到nameServer
	- 基于标签和cmdb，智能解析
		- cmdb库拉去对应信息打标
		- nameServer根据请求方标签和匹配策列返回匹配的解析记录
5. 7层负载均衡（apisix）
	1. 选型使用[APISXIX](https://apisix.apache.org/zh/)
	2. 利用Apisix插件快速扩展
	3. 标准化，与内部系统打通
	4. 域名维度配置全量增量更新，多云同步一致
	5. 集群均分流量，网络，集群异常通过DNS屏蔽
![[Pasted image 20230530231703.png]]
6. 控制成本
	1. 监控
	2. 计费控制成本，以天为维度发现top成本
	3. 分摊，选取体现最终成本的指标进行计费
	4. 预警，天为单位，费用变化幅度大的发送告警

### 流量调度体系

#### 接入调度
1. 多区域多cdn，公网DNS切换
2. 客户端cdn重试，浏览器刷新页面
3. 屏蔽转发的单AZ流量
#### DNS解析



负载均衡设计

流量接入调度
- 多区域
	- 多cdn
- 快速屏蔽az

多云接入实施:
1. 产品选择
	1. 一般产品dns对转发的性能比较弱
	2. 